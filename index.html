<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MystiMeal - Find Your Mystery Meal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="manifest" href="/manifest.json">
    <style>
        /* Custom styles based on previous version for main listings */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f9f9f9; /* Very light background */
            color: #333;
            line-height: 1.6;
        }
        /* Styling for the scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #999; }

        /* Original Card styling for main listings */
        .restaurant-card {
            background-color: #fff;
            border-radius: 4px; /* Less rounded corners */
            box-shadow: 0 1px 5px rgba(0,0,0,0.05); /* Subtle shadow */
            overflow: hidden;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            border: 1px solid #eee;
        }
        .restaurant-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.08);
        }
         .restaurant-card img {
             width: 100%;
             height: 180px;
             object-fit: cover;
         }
         .restaurant-card .card-content {
             padding: 15px;
             display: flex;
             flex-direction: column;
             flex-grow: 1;
         }
          .restaurant-card h3 {
              font-size: 1.1rem;
              font-weight: 500;
              margin-bottom: 4px;
              color: #1f2937;
          }
           .restaurant-card .restaurant-name {
               font-size: 0.875rem;
               color: #6b7280;
               margin-bottom: 6px;
           }
            .restaurant-card .bag-info {
                 font-size: 0.8rem;
                 color: #6b7280;
                 margin-bottom: 8px;
            }
            .restaurant-card .price {
                font-size: 1.2rem;
                font-weight: 700;
                color: #0da487;
                margin-top: auto;
                margin-bottom: 12px;
            }
             .restaurant-card .view-details-button {
                 width: 100%;
                 background-color: #fff;
                 color: #333;
                 padding: 10px 16px;
                 border-radius: 4px;
                 font-weight: 500;
                 text-align: center;
                 transition: all 0.2s ease;
                 border: 1px solid #d1d5db;
             }
             .restaurant-card .view-details-button:hover {
                 background-color: #f3f4f6;
                 border-color: #cCc;
             }

         /* Rating Display Styling (used in modal and main cards) */
         .rating {
             display: flex;
             align-items: center;
             font-size: 0.9rem;
             color: #ffc107;
             margin-bottom: 6px;
         }
          .rating .stars {
              margin-right: 4px;
          }
          .rating .fas.fa-star,
          .rating .fas.fa-star-half-alt {
              color: #ffc107;
          }
           .rating .fas.fa-star-half-alt::before {
               content: '\f089';
               position: absolute;
               left: 0;
               overflow: hidden;
               width: 50%;
           }
         .rating .rating-text {
             color: #4b5563;
             font-weight: 500;
         }


        /* Category button styling (keeping the chip style) */
        .category-chip {
            display: inline-flex;
            align-items: center;
            background-color: #e5e7eb;
            color: #4b5563;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            border: 1px solid transparent;
        }
        .category-chip i {
            margin-right: 8px;
            font-size: 1rem;
        }
        .category-chip.active {
            background-color: #0da487;
            color: white;
            border-color: #0a8a72;
        }
         .category-chip:hover:not(.active) {
             background-color: #d1d5db;
         }


        /* Primary button style (used for search and modal actions) */
        .primary-button {
            background-color: #0da487;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }
        .primary-button:hover {
            background-color: #0a8a72;
        }

        /* Secondary button style (used for back button) */
        .secondary-button {
            background-color: #e5e7eb;
            color: #4b5563;
            padding: 12px 24px;
            border-radius: 4px;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }
         .secondary-button:hover {
             background-color: #d1d5db;
         }

         /* Warning button style (used for remove from cart) */
        .warning-button {
             background-color: #ef4444;
             color: white;
        }
        .warning-button:hover {
             background-color: #dc2626;
        }

        /* Modal transition effects */
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }

        /* Modal specific styles (keeping previous styles as they are for the modal) */
        .modal-content {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }
        .modal-content h3 {
            color: #1f2937;
            font-size: 1.6rem;
            font-weight: 700;
        }
         .menu-item, .bag-size-item {
            border-bottom: 1px dashed #eee;
            padding-bottom: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
         .menu-item:last-child, .bag-size-item:last-child {
             border-bottom: none;
             margin-bottom: 0;
             padding-bottom: 0;
         }
         .add-to-cart-btn {
             background-color: #0da487;
             color: white;
             padding: 6px 14px;
             border-radius: 4px;
             font-size: 0.9rem;
             font-weight: 500;
             transition: background-color 0.2s ease;
         }
         .add-to-cart-btn:hover {
             background-color: #0a8a72;
         }
         .remove-item-btn {
             background-color: #ef4444;
             color: white;
             padding: 4px 10px;
             border-radius: 4px;
             font-size: 0.8rem;
             transition: background-color 0.2s ease;
         }
         .remove-item-btn:hover {
             background-color: #dc2626;
         }
         .modal-view {
             display: none;
         }
         .modal-view.active {
             display: block;
         }

         /* Specific styles for the login/signup/otp screens to match the overall theme */
        #authScreen {
            background-color: #f9f9f9;
        }
        .auth-card {
            background-color: #fff;
            border-radius: 8px;
            padding: 2.5rem;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }
        .auth-card h1 {
            color: #1f2937;
            font-size: 2.2rem;
            font-weight: 700;
        }
         .auth-card .primary-button {
             padding: 14px 28px;
             font-size: 1rem;
         }
          .phone-input-container {
              border-color: #ddd;
              border-radius: 4px;
          }
          .phone-input-container span {
              background-color: #f9f9f9;
              border-right-color: #ddd;
          }
           .phone-input-container input:focus {
               border-color: #0da487;
               box-shadow: 0 0 0 1px #0da487;
           }
           .auth-card p {
               color: #4b5563;
           }

           .auth-view {
               display: none;
           }
            .auth-view.active {
                display: block;
            }

            /* OTP Input Styling */
            .otp-input {
                width: 60px;
                height: 60px;
                text-align: center;
                font-size: 1.5rem;
                margin: 0 5px;
                border: 1px solid #d1d5db;
                border-radius: 4px;
                transition: border-color 0.2s ease, box-shadow 0.2s ease;
            }
             .otp-input:focus {
                 outline: none;
                 border-color: #0da487;
                 box-shadow: 0 0 0 1px #0da487;
             }


        /* Header styling */
        .app-header {
            background-color: #ffffff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.03);
            padding-top: 12px;
            padding-bottom: 12px;
        }
         .app-header h1 {
             font-size: 1.6rem;
             font-weight: 700;
             color: #1f2937;
         }
          .app-header .fa-search, .app-header .fa-user-circle {
              font-size: 1.1rem;
              color: #555;
          }
           .app-header button:hover .fa-search, .app-header button:hover .fa-user-circle {
               color: #0da487;
           }


        /* Main content padding */
        main {
            padding-top: 30px;
            padding-bottom: 30px;
        }
         main h2 {
             font-size: 1.6rem;
             font-weight: 700;
             color: #1f2937;
             margin-bottom: 4px;
         }
          main p {
              color: #4b5563;
              font-size: 0.9rem;
          }

        /* Category filter container */
        .category-filter-container {
             margin-bottom: 30px;
             padding-bottom: 8px;
             overflow-x: auto;
             -webkit-overflow-scrolling: touch;
        }
         .category-filter-container::-webkit-scrollbar {
             display: none;
         }


        /* Search bar styling */
        .search-bar-container {
            padding: 12px;
            background-color: #fff;
            border-radius: 4px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #eee;
            margin-bottom: 30px;
        }
         .search-bar-container input {
             flex-grow: 1;
             padding: 8px 12px;
             border: 1px solid #eee;
             border-radius: 4px;
             font-size: 0.9rem;
             color: #333;
         }
          .search-bar-container input::placeholder {
              color: #9ca3af;
          }
           .search-bar-container input:focus {
               outline: none;
               border-color: #0da487;
               box-shadow: 0 0 0 1px #0da487;
           }
           .search-bar-container .primary-button {
               padding: 8px 16px;
               font-size: 0.9rem;
               border-radius: 4px;
           }

        /* Bag listings grid */
        #bagListings {
             gap: 20px;
        }

         /* Hot Deals Section Styling (keeping previous styles) */
         .hot-deals-section {
             margin-bottom: 30px;
         }
          .hot-deals-section h3 {
              font-size: 1.4rem;
              font-weight: 700;
              color: #1f2937;
              margin-bottom: 15px;
          }
          .hot-deals-container {
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
              gap: 20px;
          }
           .hot-deal-card {
               background-color: #fff;
               border-radius: 8px;
               box-shadow: 0 2px 8px rgba(0,0,0,0.08);
               overflow: hidden;
               cursor: pointer;
               transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
               border: 1px solid #eee;
           }
            .hot-deal-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            }
            .hot-deal-card img {
                width: 100%;
                height: 160px;
                object-fit: cover;
            }
             .hot-deal-card .deal-content {
                 padding: 15px;
             }
              .hot-deal-card h4 {
                  font-size: 1.1rem;
                  font-weight: 600;
                  color: #1f2937;
                  margin-bottom: 4px;
              }
               .hot-deal-card p {
                   font-size: 0.9rem;
                   color: #4b5563;
                   margin-bottom: 8px;
               }
                .hot-deal-card .deal-price {
                    font-size: 1.3rem;
                    font-weight: 700;
                    color: #ef4444;
                }
                .hot-deal-card .deal-tag {
                    display: inline-block;
                    background-color: #fef3c7;
                    color: #92400e;
                    font-size: 0.75rem;
                    font-weight: 600;
                    padding: 3px 8px;
                    border-radius: 12px;
                    margin-bottom: 8px;
                }

         /* New or Trending Section Styling (keeping previous styles) */
         .new-trending-section {
             margin-bottom: 30px;
         }
          .new-trending-section h3 {
              font-size: 1.4rem;
              font-weight: 700;
              color: #1f2937;
              margin-bottom: 15px;
          }
          .new-trending-container {
               display: grid;
               grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
               gap: 20px;
          }
           .new-trending-card {
               background-color: #fff;
               border-radius: 8px;
               box-shadow: 0 2px 8px rgba(0,0,0,0.08);
               overflow: hidden;
               cursor: pointer;
               transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
               border: 1px solid #eee;
           }
            .new-trending-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            }
            .new-trending-card img {
                width: 100%;
                height: 160px;
                object-fit: cover;
            }
             .new-trending-card .deal-content {
                 padding: 15px;
             }
              .new-trending-card h4 {
                  font-size: 1.1rem;
                  font-weight: 600;
                  color: #1f2937;
                  margin-bottom: 4px;
              }
               .new-trending-card p {
                   font-size: 0.9rem;
                   color: #4b5563;
                   margin-bottom: 8px;
               }
                .new-trending-card .deal-price {
                    font-size: 1.3rem;
                    font-weight: 700;
                    color: #0da487;
                }
                .new-trending-card .deal-tag {
                    display: inline-block;
                    background-color: #d1fae5;
                    color: #065f46;
                    font-size: 0.75rem;
                    font-weight: 600;
                    padding: 3px 8px;
                    border-radius: 12px;
                    margin-bottom: 8px;
                }


        /* Cart Suggestions Styling (keeping previous styles) */
        .suggestions-container {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px dashed #eee;
        }
        .suggestions-container h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 10px;
        }
        .suggestion-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #f3f4f6;
        }
         .suggestion-item:last-child {
             border-bottom: none;
             padding-bottom: 0;
         }
        .suggestion-item .item-details {
            display: flex;
            align-items: center;
            gap: 10px;
        }
         .suggestion-item img {
             width: 40px;
             height: 40px;
             object-fit: cover;
             border-radius: 4px;
         }
         .suggestion-item .item-info span {
             display: block;
             font-size: 0.875rem;
             color: #333;
         }
          .suggestion-item .item-info .price {
              font-size: 0.8rem;
              color: #6b7280;
          }
        .suggestion-item .add-button {
            background-color: #0da487;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }
         .suggestion-item .add-button:hover {
             background-color: #0a8a72;
         }

         /* Checkout Address and Payment Styling (keeping previous styles) */
         .checkout-section {
             margin-bottom: 20px;
             padding: 15px;
             background-color: #fff;
             border-radius: 8px;
             box-shadow: 0 1px 5px rgba(0,0,0,0.05);
             border: 1px solid #eee;
         }
          .checkout-section h4 {
              font-size: 1.1rem;
              font-weight: 600;
              color: #1f2937;
              margin-bottom: 15px;
          }
           .checkout-section label {
               font-size: 0.875rem;
               font-weight: 500;
               color: #333;
               display: block;
               margin-bottom: 6px;
           }
            .checkout-section input[type="text"],
            .checkout-section textarea,
            .checkout-section select {
                width: 100%;
                padding: 10px 12px;
                border: 1px solid #d1d5db;
                border-radius: 4px;
                font-size: 0.9rem;
                color: #333;
                transition: border-color 0.2s ease, box-shadow 0.2s ease;
            }
             .checkout-section input[type="text"]:focus,
             .checkout-section textarea:focus,
             .checkout-section select:focus {
                 outline: none;
                 border-color: #0da487;
                 box-shadow: 0 0 0 1px rgba(13, 164, 135, 0.2);
             }
             .checkout-section textarea {
                 min-height: 80px;
                 resize: vertical;
             }

            .payment-method-option {
                display: flex;
                align-items: center;
                margin-bottom: 10px;
            }
             .payment-method-option input[type="radio"] {
                 margin-right: 10px;
                 accent-color: #0da487;
             }
              .payment-method-option label {
                  margin-bottom: 0;
                  font-weight: 400;
                  color: #4b5563;
              }

              .delivery-option {
                  display: flex;
                  align-items: center;
                  margin-bottom: 10px;
              }
               .delivery-option input[type="radio"] {
                   margin-right: 10px;
                   accent-color: #0da487;
               }
                .delivery-option label {
                    margin-bottom: 0;
                    font-weight: 400;
                    color: #4b5563;
                }

               .delivery-priority-option {
                   display: flex;
                   align-items: center;
                   margin-bottom: 10px;
               }
                .delivery-priority-option input[type="radio"] {
                    margin-right: 10px;
                    accent-color: #0da487;
                }
                 .delivery-priority-option label {
                     margin-bottom: 0;
                     font-weight: 400;
                     color: #4b5563;
                 }
                 .delivery-priority-option .extra-charge {
                     font-size: 0.8rem;
                     color: #6b7280;
                     margin-left: 5px;
                 }

            /* User Account Screen Styles (keeping previous styles) */
            #userAccountScreen {
                background-color: #f9f9f9;
                padding-top: 20px;
            }
             #userAccountScreen h2 {
                 font-size: 1.8rem;
                 font-weight: 700;
                 color: #1f2937;
                 margin-bottom: 20px;
             }
              .account-section {
                  margin-bottom: 30px;
                  padding: 20px;
                  background-color: #fff;
                  border-radius: 8px;
                  box-shadow: 0 1px 5px rgba(0,0,0,0.05);
                  border: 1px solid #eee;
              }
               .account-section h3 {
                   font-size: 1.4rem;
                   font-weight: 600;
                   color: #1f2937;
                   margin-bottom: 15px;
                   border-bottom: 1px dashed #eee;
                   padding-bottom: 10px;
               }

               /* Order History Styles (keeping previous styles) */
               .order-item {
                   border-bottom: 1px solid #eee;
                   padding: 15px 0;
               }
                .order-item:last-child {
                    border-bottom: none;
                }
               .order-item .order-header {
                   display: flex;
                   justify-content: space-between;
                   align-items: center;
                   margin-bottom: 10px;
               }
                .order-item .order-header .restaurant-name {
                    font-weight: 600;
                    color: #1f2937;
                }
                 .order-item .order-header .order-date {
                     font-size: 0.8rem;
                     color: #6b7280;
                 }
                .order-item .order-details {
                    font-size: 0.9rem;
                    color: #4b5563;
                    margin-bottom: 10px;
                }
                 .order-item .order-total {
                     font-weight: 600;
                     color: #0da487;
                 }
                  .order-item .order-status {
                      font-size: 0.8rem;
                      font-weight: 600;
                      padding: 4px 8px;
                      border-radius: 4px;
                  }
                   .order-item .order-status.delivered {
                       background-color: #d1fae5;
                       color: #065f46;
                   }
                    .order-item .order-status.pending {
                        background-color: #fef3c7;
                        color: #92400e;
                    }
                    .order-item .order-status.cancelled {
                        background-color: #fee2e2;
                        color: #991b1b;
                    }
                    .order-item .view-receipt-button {
                        background-color: #e5e7eb;
                        color: #4b5563;
                        padding: 6px 12px;
                        border-radius: 4px;
                        font-size: 0.8rem;
                        font-weight: 500;
                        transition: background-color 0.2s ease;
                    }
                     .order-item .view-receipt-button:hover {
                         background-color: #d1d5db;
                     }


               /* Profile Management Styles (keeping previous styles) */
               .profile-form .form-group {
                   margin-bottom: 15px;
               }
                .profile-form label {
                    font-size: 0.875rem;
                    font-weight: 500;
                    color: #333;
                    display: block;
                    margin-bottom: 6px;
                }
                 .profile-form input[type="text"],
                 .profile-form input[type="email"],
                 .profile-form input[type="tel"] {
                     width: 100%;
                     padding: 10px 12px;
                     border: 1px solid #d1d5db;
                     border-radius: 4px;
                     font-size: 0.9rem;
                     color: #333;
                     transition: border-color 0.2s ease, box-shadow 0.2s ease;
                 }
                  .profile-form input[type="text"]:focus,
                  .profile-form input[type="email"]:focus,
                  .profile-form input[type="tel"]:focus {
                      outline: none;
                      border-color: #0da487;
                      box-shadow: 0 0 0 1px rgba(13, 164, 135, 0.2);
                  }
                 .profile-form .save-button {
                     background-color: #0da487;
                     color: white;
                     padding: 10px 20px;
                     border-radius: 4px;
                     font-weight: 500;
                     transition: background-color 0.2s ease;
                 }
                  .profile-form .save-button:hover {
                      background-color: #0a8a72;
                  }

               /* Persistent Cart Styles (keeping previous styles) */
               .persistent-cart-item {
                   border-bottom: 1px solid #eee;
                   padding: 15px 0;
               }
                .persistent-cart-item:last-child {
                    border-bottom: none;
                }
                .persistent-cart-item .item-details {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    margin-bottom: 10px;
                }
                 .persistent-cart-item img {
                     width: 50px;
                     height: 50px;
                     object-fit: cover;
                     border-radius: 4px;
                 }
                  .persistent-cart-item .item-info span {
                      display: block;
                      font-size: 0.9rem;
                      color: #333;
                  }
                   .persistent-cart-item .item-info .price {
                       font-size: 0.8rem;
                       color: #6b7280;
                   }
               .persistent-cart-actions {
                   display: flex;
                   gap: 10px;
                   justify-content: flex-end;
               }
                .persistent-cart-actions button {
                    padding: 6px 12px;
                    border-radius: 4px;
                    font-size: 0.8rem;
                    font-weight: 500;
                    transition: background-color 0.2s ease;
                }
                 .persistent-cart-actions .continue-button {
                     background-color: #0da487;
                     color: white;
                 }
                  .persistent-cart-actions .continue-button:hover {
                      background-color: #0a8a72;
                  }
                 .persistent-cart-actions .clear-button {
                     background-color: #ef4444;
                     color: white;
                 }
                  .persistent-cart-actions .clear-button:hover {
                      background-color: #dc2626;
                  }

                /* Order Progress Styles (keeping previous styles) */
                #orderProgressView {
                    background-color: #f9f9f9;
                    padding-top: 20px;
                }
                 #orderProgressView h2 {
                     font-size: 1.8rem;
                     font-weight: 700;
                     color: #1f2937;
                     margin-bottom: 20px;
                 }
                  .progress-section {
                      margin-bottom: 20px;
                      padding: 20px;
                      background-color: #fff;
                      border-radius: 8px;
                      box-shadow: 0 1px 5px rgba(0,0,0,0.05);
                      border: 1px solid #eee;
                  }
                   .progress-section h3 {
                       font-size: 1.4rem;
                       font-weight: 600;
                       color: #1f2937;
                       margin-bottom: 15px;
                       border-bottom: 1px dashed #eee;
                       padding-bottom: 10px;
                   }
                   .progress-step {
                       display: flex;
                       align-items: center;
                       margin-bottom: 15px;
                   }
                    .progress-step .icon {
                        width: 30px;
                        height: 30px;
                        border-radius: 50%;
                        background-color: #eee;
                        color: #888;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 0.9rem;
                        transition: background-color 0.5s ease, color 0.5s ease;
                    }
                     .progress-step.completed .icon {
                         background-color: #0da487;
                         color: white;
                     }
                    .progress-step .text {
                        margin-left: 15px;
                    }
                    .progress-step .text span {
                        display: block;
                        font-size: 0.9rem;
                        color: #333;
                    }
                     .progress-step .text .status {
                         font-size: 0.8rem;
                         color: #6b7280;
                     }
                    .progress-line {
                        width: 2px;
                        background-color: #eee;
                        margin-left: 14px;
                        height: 20px;
                        transition: background-color 0.5s ease;
                    }
                     .progress-step:last-child .progress-line {
                         display: none;
                     }


            /* Map Placeholder Styling (keeping previous styles) */
            .map-placeholder {
                width: 100%;
                height: 200px;
                background-color: #e0e0e0;
                border-radius: 4px;
                margin-bottom: 15px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #555;
                font-size: 1rem;
                border: 1px solid #ccc;
            }

            /* Receipt View Styles (keeping previous styles) */
            #receiptView {
                 background-color: #f9f9f9;
                 padding-top: 20px;
            }
             #receiptView h2 {
                 font-size: 1.8rem;
                 font-weight: 700;
                 color: #1f2937;
                 margin-bottom: 20px;
             }
             .receipt-section {
                 margin-bottom: 20px;
                 padding: 20px;
                 background-color: #fff;
                 border-radius: 8px;
                 box-shadow: 0 1px 5px rgba(0,0,0,0.05);
                 border: 1px solid #eee;
             }
              .receipt-section h3 {
                  font-size: 1.4rem;
                  font-weight: 600;
                  color: #1f2937;
                  margin-bottom: 15px;
                  border-bottom: 1px dashed #eee;
                  padding-bottom: 10px;
              }
              .receipt-details p {
                  margin-bottom: 8px;
                  font-size: 0.9rem;
                  color: #4b5563;
              }
               .receipt-details strong {
                   color: #1f2937;
               }
             .receipt-item-details {
                 display: flex;
                 align-items: center;
                 gap: 10px;
                 margin-bottom: 5px;
             }
              .receipt-item-details img {
                  width: 40px;
                  height: 40px;
                  object-fit: cover;
                  border-radius: 4px;
              }
               .receipt-item-details .item-info span {
                   display: block;
                   font-size: 0.9rem;
                   color: #333;
               }
                .receipt-item-details .item-info .price {
                    font-size: 0.8rem;
                    color: #6b7280;
                }

        /* Cart Item Quantity Controls (keeping previous styles) */
        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .quantity-button {
            background-color: #e5e7eb;
            color: #4b5563;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .quantity-button:hover {
            background-color: #d1d5db;
        }
        .quantity-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .cart-item-quantity span {
            font-size: 1rem;
            font-weight: 500;
            color: #1f2937;
        }

         /* Dine & Save Section (Updated Structure and Styling) */
        .dine-save-section {
            background-color: #E0F2F7; /* Light blue background */
            border-radius: 8px;
            padding: 0; /* Remove padding from the container */
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            overflow: hidden;
        }
         .dine-save-header {
             background-color: #0EA5E9; /* Sky blue header */
             color: white;
             padding: 15px 20px;
             width: 100%;
             text-align: center;
         }
          .dine-save-header h3 {
              font-size: 1.6rem;
              font-weight: 700;
              margin-bottom: 5px;
              color: white; /* Ensure title is white */
          }
           .dine-save-header p {
               font-size: 1rem;
               font-weight: 400;
               color: rgba(255, 255, 255, 0.9); /* Slightly transparent white */
               margin-bottom: 0;
           }

        .booking-form-container {
            background-color: #fff; /* White background for the form card */
            border-radius: 8px;
            padding: 20px;
            width: 100%; /* Take full width of the parent */
            box-sizing: border-box; /* Include padding in width */
             display: flex; /* Use flex for layout */
             flex-direction: column;
             align-items: center;
        }


        .booking-form {
            width: 100%;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px dashed #94a3b8;
            display: none; /* Initially hidden */
            opacity: 0;
            transition: opacity 0.3s ease;
        }
         .booking-form.active {
             display: block;
             opacity: 1;
         }

         .booking-form .form-group {
             margin-bottom: 15px;
             text-align: left;
             width: 100%; /* Make form groups take full width */
         }
          .booking-form label {
              font-size: 0.9rem;
              font-weight: 500;
              color: #333;
              display: block;
              margin-bottom: 6px;
          }
           .booking-form input[type="date"],
           .booking-form input[type="time"],
           .booking-form input[type="number"],
           .booking-form select {
               width: 100%;
               padding: 10px 12px;
               border: 1px solid #d1d5db;
               border-radius: 4px;
               font-size: 0.9rem;
               color: #333;
               transition: border-color 0.2s ease, box-shadow 0.2s ease;
           }
            .booking-form input[type="date"]:focus,
            .booking-form input[type="time"]:focus,
            .booking-form input[type="number"]:focus,
            .booking-form select:focus {
                outline: none;
                border-color: #0EA5E9;
                box-shadow: 0 0 0 1px rgba(14, 165, 233, 0.2);
            }

           .unlock-deal-button {
               background-color: #f97316; /* Orange */
               color: white;
               padding: 12px 24px;
               border-radius: 4px;
               font-weight: 600;
               transition: background-color 0.2s ease;
               width: 100%;
               margin-top: 20px;
           }
           .unlock-deal-button:hover {
               background-color: #ea580c;
           }

            /* Book a Table Header Section */
            .book-table-header {
                background-color: #FEE2E2; /* Light red/pinkish background */
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 30px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                display: flex;
                align-items: center;
                justify-content: space-between;
                cursor: pointer; /* Make the header clickable */
            }
             .book-table-header .header-text h3 {
                 font-size: 1.6rem;
                 font-weight: 700;
                 color: #991b1b; /* Dark red */
                 margin-bottom: 5px;
             }
              .book-table-header .header-text p {
                  font-size: 1rem;
                  color: #7f1d1d; /* Darker red */
                  margin-bottom: 0;
              }
              .book-table-header .header-icon i {
                  font-size: 2.5rem;
                  color: #991b1b; /* Dark red icon */
              }

             /* New styles for Bookable Restaurant Cards within the booking form */
             .bookable-restaurant-card {
                 background-color: #fff;
                 border-radius: 8px;
                 box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                 overflow: hidden;
                 transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
                 display: flex;
                 flex-direction: column;
                 border: 1px solid #eee;
                 margin-bottom: 15px; /* Add margin between cards */
                 cursor: pointer; /* Make the card clickable */
             }
             .bookable-restaurant-card:hover {
                 transform: translateY(-3px);
                 box-shadow: 0 4px 12px rgba(0,0,0,0.12);
             }
              .bookable-restaurant-card .card-header {
                  padding: 15px;
                  color: white;
                  position: relative;
              }
               .bookable-restaurant-card .card-header h3 {
                   font-size: 1.2rem;
                   font-weight: 700;
                   margin-bottom: 4px;
               }
                .bookable-restaurant-card .card-header p {
                    font-size: 0.9rem;
                    font-weight: 400;
                    margin-bottom: 8px;
                }
                 .bookable-restaurant-card .discount-tag {
                     position: absolute;
                     top: 10px;
                     left: 10px;
                     background-color: rgba(255, 255, 255, 0.9);
                     color: #333;
                     font-size: 0.75rem;
                     font-weight: 600;
                     padding: 3px 8px;
                     border-radius: 4px;
                 }

              /* Specific header colors based on data (simulated) for bookable cards */
              .bookable-restaurant-card[data-color="orange"] .card-header { background-color: #FF6B00; } /* Orange */
              .bookable-restaurant-card[data-color="green"] .card-header { background-color: #4CAF50; } /* Green */
              .bookable-restaurant-card[data-color="pink"] .card-header { background-color: #E91E63; } /* Pink */
               /* Add more colors as needed */


              .bookable-restaurant-card .card-content {
                  padding: 15px;
                  display: flex;
                  flex-direction: column;
                  flex-grow: 1;
              }
               .bookable-restaurant-card .restaurant-name-content {
                   font-size: 1rem;
                   font-weight: 600;
                   color: #1f2937;
                   margin-bottom: 4px;
               }
                .bookable-restaurant-card .category-content {
                    font-size: 0.875rem;
                    color: #6b7280;
                    margin-bottom: 6px;
                }
                 .bookable-restaurant-card .price-content {
                     font-size: 1.1rem;
                     font-weight: 700;
                     color: #0da487;
                     margin-top: auto;
                     margin-bottom: 12px;
                 }
                  .bookable-restaurant-card .unlock-deal-button {
                      width: 100%;
                      background-color: #FF6B00;
                      color: white;
                      padding: 10px 16px;
                      border-radius: 4px;
                      font-weight: 600;
                      text-align: center;
                      transition: background-color 0.2s ease;
                  }
                  .bookable-restaurant-card .unlock-deal-button:hover {
                      background-color: #E05A00;
                  }
                  .bookable-restaurant-card .tap-card-info {
                      font-size: 0.75rem;
                      color: #9ca3af;
                      text-align: center;
                      margin-top: 8px;
                  }
                  .bookable-restaurant-card.selected-for-booking {
                       border-color: #0EA5E9; /* Highlight color */
                       box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2); /* Subtle glow */
                  }


           /* Pending Bookings Section (keeping previous styles) */
           .pending-booking-item {
               border-bottom: 1px solid #eee;
               padding: 15px 0;
           }
            .pending-booking-item:last-child {
                border-bottom: none;
            }
           .pending-booking-item .booking-details {
               font-size: 0.9rem;
               color: #4b5563;
               margin-bottom: 10px;
           }
            .pending-booking-item .booking-details strong {
                color: #1f2937;
            }
           .pending-booking-actions {
               display: flex;
               gap: 10px;
               justify-content: flex-end;
               align-items: center;
           }
            .pending-booking-actions button {
                padding: 6px 12px;
                border-radius: 4px;
                font-size: 0.8rem;
                font-weight: 500;
                transition: background-color 0.2s ease;
            }
             .pending-booking-actions .receive-bill-button {
                 background-color: #3b82f6;
                 color: white;
             }
              .pending-booking-actions .receive-bill-button:hover {
                  background-color: #2563eb;
              }
             .pending-booking-actions .pay-now-button {
                 background-color: #0da487;
                 color: white;
             }
              .pending-booking-actions .pay-now-button:hover {
                  background-color: #0a8a72;
              }
             .pending-booking-actions .cancel-button {
                 background-color: #e5e7eb;
                 color: #4b5563;
             }
              .pending-booking-actions .cancel-button:hover {
                  background-color: #d1d5db;
             }
             .pending-booking-actions .bill-amount {
                 font-weight: 600;
                 color: #1f2937;
                 margin-right: 10px;
             }


    </style>
</head>
<body class="antialiased">

    <div id="authScreen" class="fixed inset-0 z-50 flex flex-col items-center justify-center p-4">
        <div class="auth-card text-center w-full max-w-sm">
            <img src="https://i.postimg.cc/MpMtg5nY/Whats-App-Image-2025-04-01-at-9-30-24-PM.jpg" alt="MystiMeal Logo" class="mx-auto mb-6 rounded-full">
            <h1 class="text-4xl font-bold text-gray-800 mb-3">MystiMeal</h1>
            <p class="text-gray-600 mb-8">Save food. Save money. Stay curious.</p>

            <div id="loginView" class="auth-view active">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Login</h2>
                <p class="text-left text-sm text-gray-500 mb-2">Enter your phone number to sign in</p>
                <div class="phone-input-container mb-8 flex items-center border border-gray-300 rounded-md">
                    <span class="px-3 py-2 bg-gray-100 border-r border-gray-300">ðŸ‡®ðŸ‡³ +91</span>
                    <input type="tel" id="loginPhone" placeholder="9876543210" class="w-full px-3 py-2 rounded-r-md focus:outline-none">
                </div>
                <button id="loginButton" class="w-full primary-button font-semibold py-3 px-6 rounded-lg shadow-md transition duration-150">
                    Login
                </button>
                <p class="text-center text-sm text-gray-500 mt-4">
                    Don't have an account? <button id="showSignupBtn" class="text-0da487 hover:underline font-medium">Sign Up</button>
                </p>
            </div>

            <div id="signupView" class="auth-view">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Sign Up</h2>
                <div class="space-y-4">
                    <div>
                        <label for="signupName" class="text-left text-sm font-medium text-gray-700 block mb-1">Name</label>
                        <input type="text" id="signupName" placeholder="Your Name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-0da487 focus:ring-1 focus:ring-0da487">
                    </div>
                    <div>
                        <label for="signupPhone" class="text-left text-sm font-medium text-gray-700 block mb-1">Phone Number</label>
                         <div class="phone-input-container flex items-center border border-gray-300 rounded-md">
                             <span class="px-3 py-2 bg-gray-100 border-r border-gray-300">ðŸ‡®ðŸ‡³ +91</span>
                             <input type="tel" id="signupPhone" placeholder="9876543210" class="w-full px-3 py-2 rounded-r-md focus:outline-none">
                         </div>
                    </div>
                    <div>
                        <label for="signupEmail" class="text-left text-sm font-medium text-gray-700 block mb-1">Email (Optional)</label>
                        <input type="email" id="signupEmail" placeholder="your.email@example.com" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-0da487 focus:ring-1 focus:ring-0da487">
                    </div>
                </div>
                <button id="signupButton" class="w-full primary-button font-semibold py-3 px-6 rounded-lg shadow-md transition duration-150 mt-8">
                    Sign Up
                </button>
                <p class="text-center text-sm text-gray-500 mt-4">
                    Already have an account? <button id="showLoginBtn" class="text-0da487 hover:underline font-medium">Login</button>
                </p>
            </div>

             <div id="otpView" class="auth-view">
                 <h2 class="text-2xl font-bold text-gray-800 mb-6">Verify Phone Number</h2>
                 <p class="text-center text-gray-600 mb-6">Enter the 4-digit OTP sent to <span id="otpPhoneNumber"></span></p>
                 <div class="flex justify-center space-x-2 mb-4">
                     <input type="text" class="otp-input" maxlength="1" id="otp1">
                     <input type="text" class="otp-input" maxlength="1" id="otp2">
                     <input type="text" class="otp-input" maxlength="1" id="otp3">
                     <input type="text" class="otp-input" maxlength="1" id="otp4">
                 </div>
                 <p id="tempOtpDisplay" class="text-center mt-2 text-sm font-semibold text-blue-600 hidden"></p>
                 <button id="verifyOtpButton" class="w-full primary-button font-semibold py-3 px-6 rounded-lg shadow-md transition duration-150 mt-4">
                     Verify OTP
                 </button>
                  <p class="text-center text-sm text-gray-500 mt-4">
                      Didn't receive the code? <button class="text-0da487 hover:underline font-medium" id="resendOtpButton">Resend OTP</button>
                  </p>
             </div>


            <p id="authMessage" class="text-center mt-4 text-sm text-gray-500"></p>
            <p class="text-xs text-gray-400 mt-6">By continuing, you agree to our <a href="#" class="underline text-gray-500 hover:text-gray-700">Terms and Conditions</a></p>
        </div>
    </div>

    <div id="mainAppContent" class="hidden">
        <header class="app-header sticky top-0 z-40">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <h1 class="text-3xl font-bold tracking-tight text-gray-800">MystiMeal</h1>
                <div class="flex items-center space-x-4">
                    <button class="text-gray-600 hover:text-0da487" onclick="showUserAccount()">
                        <i class="fas fa-user-circle text-2xl"></i> </button>
                </div>
            </div>
        </header>

        <div id="mainListingView">
             <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                 <div class="mb-8">
                     <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">Good afternoon, <span id="greetingUserName">User</span>!</h2>
                     <p class="text-gray-600 mt-1">Discover Surprise Bags Near You - Hyderabad</p>
                 </div>

                 <div class="book-table-header cursor-pointer">
                     <div class="header-text">
                         <h3>Book a table</h3>
                         <p>Get 10-20% off your meal when you book a table.</p>
                     </div>
                     <div class="header-icon">
                         <i class="fas fa-calendar-check"></i>
                     </div>
                 </div>


                 <div id="hotDealsSection" class="hot-deals-section hidden">
                     <h3>ðŸ”¥ Hot Deals Near You!</h3>
                     <div id="hotDealsContainer" class="hot-deals-container">
                         </div>
                 </div>

                 <div id="newTrendingSection" class="new-trending-section hidden">
                     <h3>âœ¨ New & Trending!</h3>
                     <div id="newTrendingContainer" class="new-trending-container">
                         </div>
                 </div>


                 <div class="category-filter-container mb-8 flex space-x-4 -mx-4 px-4 sm:mx-0 sm:px-0 overflow-x: auto">
                     <button data-category="All" class="category-chip active"><i class="fas fa-utensils"></i> All</button>
                     <button data-category="Restaurants" class="category-chip"><i class="fas fa-store"></i> Restaurants</button>
                     <button data-category="Biryani" class="category-chip"><i class="fas fa-drumstick-bite"></i> Biryani</button>
                     <button data-category="Bakery" class="category-chip"><i class="fas fa-bread-slice"></i> Bakery</button>
                     <button data-category="Cafe" class="category-chip"><i class="fas fa-coffee"></i> Cafe</button>
                     <button data-category="Fast Food" class="category-chip"><i class="fas fa-hamburger"></i> Fast Food</button>
                      <button data-category="Sweets" class="category-chip"><i class="fas fa-ice-cream"></i> Sweets</button>
                      <button data-category="Meals" class="category-chip"><i class="fas fa-concierge-bell"></i> Meals</button>
                 </div>

                 <div class="mb-8 search-bar-container">
                     <input type="text" id="restaurantSearchInput" placeholder="Search by restaurant or bag name...">
                     <button id="searchButton" class="primary-button font-semibold shadow-md transition duration-150">
                         Search
                     </button>
                 </div>

                 <div id="bagListings" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                     </div>
             </main>
        </div>

        <div id="bookingPageView" class="hidden">
             <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                 <button class="secondary-button mb-8" onclick="showMainListing()">Back to Listings</button>

                 <div id="dineSaveSection" class="dine-save-section">
                     <div class="dine-save-header">
                         <h3>Dine & Save</h3>
                         <p>Get 10% - 20% off on your bill when you reserve a table</p>
                     </div>
                     <div class="booking-form-container">
                         <h4 class="text-lg font-semibold text-gray-700 mb-4 text-center">Select a Restaurant to Book</h4>
                         <div id="bookableRestaurantsList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-8">
                             </div>

                         <div id="bookingForm" class="booking-form">
                             <h4 class="text-lg font-semibold text-gray-700 mb-4 text-center">Booking Details for <span id="selectedBookingRestaurantName"></span></h4>
                             <div class="space-y-4">
                                 <input type="hidden" id="selectedBookingRestaurantId">

                                 <div class="form-group">
                                     <label for="bookingDate">Date:</label>
                                     <input type="date" id="bookingDate">
                                 </div>
                                 <div class="form-group">
                                     <label for="bookingTime">Time:</label>
                                     <input type="time" id="bookingTime">
                                 </div>
                                 <div class="form-group">
                                     <label for="bookingGuests">Number of Guests:</label>
                                     <input type="number" id="bookingGuests" min="1" value="1">
                                 </div>
                                 <div class="form-group">
                                     <label>Table Preference:</label>
                                     <div class="flex gap-4">
                                         <label><input type="radio" name="tablePreference" value="small" id="tablePreference-small" checked> Small Gathering</label>
                                         <label><input type="radio" name="tablePreference" value="large" id="tablePreference-large"> Large Table</label>
                                     </div>
                                 </div>
                             </div>
                             <button id="confirmBookingButton" class="unlock-deal-button">
                                 Unlock Deal (Confirm Booking)
                             </button>
                             <p id="bookingMessage" class="text-center mt-4 text-sm text-gray-500"></p>
                         </div>
                     </div>
                 </div>
             </main>
        </div>


        <div id="userAccountScreen" class="hidden container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <button class="secondary-button mb-8" onclick="showMainListing()">Back to Listings</button>
            <h2>My Account</h2>

            <div id="persistentCart" class="account-section">
                <h3>Your Cart (<span id="persistentCartItemCount">0</span> items)</h3>
                <div id="persistentCartItems" class="space-y-3">
                    <p class="text-center text-gray-500">Your persistent cart is empty.</p>
                </div>
                 <div id="persistentCartActions" class="persistent-cart-actions mt-4 hidden">
                     <button class="continue-button" onclick="continueWithPersistentCart()">Continue with this Cart</button>
                     <button class="clear-button" onclick="clearPersistentCart()">Clear Cart</button>
                 </div>
            </div>

             <div id="pendingBookingsSection" class="account-section">
                 <h3>Pending Table Bookings (<span id="pendingBookingsCount">0</span>)</h3>
                 <div id="pendingBookingsList" class="space-y-4">
                     <p class="text-center text-gray-500">No pending bookings.</p>
                 </div>
             </div>


            <div id="orderHistory" class="account-section">
                <h3>Order History</h3>
                <div id="orderHistoryItems" class="space-y-4">
                    <p class="text-center text-gray-500">No past orders found.</p>
                </div>
            </div>

            <div id="userProfile" class="account-section">
                <h3>Profile Information</h3>
                <div class="profile-form space-y-4">
                    <div class="form-group">
                        <label for="profileName">Name:</label>
                        <input type="text" id="profileName" value="User Name">
                    </div>
                    <div class="form-group">
                        <label for="profilePhone">Phone:</label>
                        <input type="tel" id="profilePhone" value="+91 9876543210">
                    </div>
                    <div class="form-group">
                        <label for="profileEmail">Email:</label>
                        <input type="email" id="profileEmail" value="user@example.com">
                    </div>
                     <div class="form-group">
                         <label for="profileAddress">Default Address:</label>
                         <input type="text" id="profileAddress" value="123 Main St, Hyderabad">
                     </div>
                    <button class="save-button" onclick="saveProfile()">Save Profile</button>
                </div>
            </div>

            <button class="warning-button mt-8" onclick="signOut()">Sign Out</button>
        </div>

        <div id="orderProgressView" class="hidden container mx-auto px-4 sm:px-6 lg:px-8 py-8">
             <button class="secondary-button mb-8" onclick="showUserAccount()">Back to Account</button>
             <h2>Order Progress</h2>
             <div class="progress-section">
                 <h3>Order #<span id="currentOrderId"></span></h3>
                 <div class="progress-steps">
                     <div class="progress-step completed">
                         <div class="icon"><i class="fas fa-check"></i></div>
                         <div class="text">
                             <span>Order Placed</span>
                             <span class="status">We've received your order.</span>
                         </div>
                     </div>
                     <div class="progress-line"></div>
                     <div class="progress-step" id="stepPreparation">
                         <div class="icon"><i class="fas fa-utensils"></i></div>
                         <div class="text">
                             <span>Preparing Your Order</span>
                             <span class="status">The restaurant is getting your meal ready.</span>
                         </div>
                     </div>
                      <div class="progress-line"></div>
                     <div class="progress-step" id="stepOutForDelivery">
                         <div class="icon"><i class="fas fa-motorcycle"></i></div>
                         <div class="text">
                             <span>Out for Delivery/Ready for Pickup</span>
                             <span class="status">Your order is on its way or ready.</span>
                         </div>
                     </div>
                      <div class="progress-line"></div>
                     <div class="progress-step" id="stepDelivered">
                         <div class="icon"><i class="fas fa-box-open"></i></div>
                         <div class="text">
                             <span>Delivered/Picked Up</span>
                             <span class="status">Enjoy your MystiMeal!</span>
                         </div>
                     </div>
                 </div>
                 <p id="orderStatusMessage" class="text-center mt-6 text-lg font-semibold text-gray-700"></p>
             </div>
        </div>

        <div id="receiptView" class="hidden container mx-auto px-4 sm:px-6 lg:px-8 py-8">
             <button class="secondary-button mb-8" onclick="showUserAccount()">Back to Account</button>
             <h2>Order Receipt #<span id="receiptOrderId"></span></h2>
             <div class="receipt-section">
                 <h3>Order Summary</h3>
                 <div id="receiptSummary" class="receipt-details">
                     </div>
             </div>
             <div class="receipt-section">
                 <h3>Items Ordered</h3>
                 <div id="receiptItems" class="receipt-details space-y-2">
                     </div>
             </div>
             <div class="receipt-section">
                 <h3>Delivery/Pickup Details</h3>
                 <div id="receiptDeliveryDetails" class="receipt-details">
                     </div>
             </div>
             <div class="receipt-section">
                 <h3>Payment Information</h3>
                 <div id="receiptPaymentDetails" class="receipt-details">
                     </div>
             </div>
             <div class="receipt-section">
                 <div class="flex justify-between items-center text-lg font-bold text-gray-800">
                      <span>Total:</span>
                      <span id="receiptTotal">â‚¹0</span>
                 </div>
             </div>
        </div>


        <div id="bagDetailModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 opacity-0 pointer-events-none p-4">
            <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform scale-95 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 id="modalRestaurantTitle" class="text-2xl font-bold text-gray-800">Restaurant Name</h3>
                         <div id="modalRestaurantRating" class="rating">
                              <div class="stars"></div>
                              <span class="rating-text"></span>
                         </div>
                    </div>
                    <button id="closeModalButton" class="text-gray-500 hover:text-gray-700 text-3xl leading-none">&times;</button>
                </div>

                <div id="bagMenuDetailView" class="modal-view active">
                    <img id="modalRestaurantImage" src="" alt="Restaurant Image" class="w-full h-48 object-cover rounded-lg mb-4 shadow">

                    <div class="mb-6">
                        <h4 class="text-lg font-semibold text-gray-700 mb-2">Surprise Bags</h4>
                        <div id="modalBagSizes" class="space-y-3">
                            </div>
                    </div>

                    <div class="mb-6">
                        <p class="font-semibold text-gray-700 mb-1">Available Pickup Times:</p>
                        <div id="modalPickupTimes" class="flex flex-wrap gap-2">
                            </div>
                    </div>

                    <div class="mt-4 border-t pt-4">
                        <h4 class="text-lg font-semibold text-gray-700 mb-2">Full Restaurant Menu (Sample)</h4>
                        <div id="modalFullMenu" class="text-sm text-gray-600 space-y-1">
                            </div>
                    </div>
                </div>

                <div id="cartView" class="modal-view">
                     <h4 class="text-lg font-semibold text-gray-700 mb-4">Your Cart</h4>
                     <div id="cartItems" class="space-y-3">
                         </div>
                     <div id="cartTotal" class="text-lg font-bold text-gray-800 mt-4 text-right">
                         Total: â‚¹0 </div>

                     <div id="cartSuggestions" class="suggestions-container">
                         </div>
                </div>

                <div id="checkoutAddressView" class="modal-view">
                     <div class="checkout-section">
                         <h4>Choose Delivery Option</h4>
                         <div class="space-y-4">
                             <div class="delivery-option">
                                 <input type="radio" name="deliveryOption" value="pickup" id="optionPickup" checked>
                                 <label for="optionPickup">Pickup</label>
                             </div>
                             <div class="delivery-option">
                                 <input type="radio" name="deliveryOption" value="delivery" id="optionDelivery">
                                 <label for="optionDelivery">Delivery</label>
                             </div>
                         </div>
                     </div>

                     <div id="deliveryAddressFields" class="checkout-section mt-4 hidden">
                         <h4>Delivery Details</h4>
                         <div class="space-y-4">
                             <div class="map-placeholder">
                                 Map Placeholder - Click to Select Address
                             </div>
                             <div>
                                 <label for="address">Delivery Address</label>
                                 <input type="text" id="address" placeholder="Enter your delivery address">
                             </div>
                             <div>
                                 <label for="dropoff">Dropoff Instructions (Optional)</label>
                                 <textarea id="dropoff" rows="3" placeholder="e.g., Leave at door, Ring doorbell"></textarea>
                             </div>
                         </div>
                     </div>
                </div>

                <div id="checkoutTimeView" class="modal-view">
                     <div class="checkout-section">
                         <h4>Time Preferences</h4>
                         <div class="space-y-4">
                              <div>
                                  <label for="timeZone">Time Zone</label>
                                  <select id="timeZone">
                                      <option value="UTC+5:30">India Standard Time (UTC+5:30)</option>
                                      </select>
                              </div>
                             <div>
                                 <label for="pickupTime">Preferred Time</label>
                                 <select id="pickupTime">
                                     </select>
                             </div>
                             <p class="text-sm text-gray-500">Note: Surprise bags have specific pickup windows. Full menu orders can be scheduled within restaurant hours.</p>
                         </div>
                     </div>

                     <div id="deliveryPrioritySection" class="checkout-section mt-4 hidden">
                         <h4>Delivery Priority</h4>
                         <div class="space-y-4">
                             <div class="delivery-priority-option">
                                 <input type="radio" name="deliveryPriority" value="regular" id="priorityRegular" checked>
                                 <label for="priorityPriority">Regular Delivery</label>
                             </div>
                             <div class="delivery-priority-option">
                                 <input type="radio" name="deliveryPriority" value="priority" id="priorityPriority">
                                 <label for="priorityPriority">Priority Delivery <span class="extra-charge">(+â‚¹50)</span></label>
                             </div>
                         </div>
                     </div>
                </div>

                 <div id="checkoutPaymentView" class="modal-view">
                     <div class="checkout-section">
                         <h4>Payment Method</h4>
                         <div class="space-y-4">
                             <div class="payment-method-option">
                                 <input type="radio" name="paymentMethod" value="card" id="paymentCard">
                                 <label for="paymentCard">Credit/Debit Card (Simulated)</label>
                             </div>
                              <div id="cardDetails" class="space-y-4 pl-6 mt-2 hidden">
                                   <div>
                                       <label for="cardNumber">Card Number (Dummy)</label>
                                       <input type="text" id="cardNumber" placeholder="XXXX XXXX XXXX XXXX">
                                   </div>
                                   <div class="flex gap-4">
                                       <div class="flex-1">
                                           <label for="expiryDate">Expiry Date (MM/YY)</label>
                                           <input type="text" id="expiryDate" placeholder="MM/YY">
                                       </div>
                                       <div class="flex-1">
                                            <label for="cvv">CVV</label>
                                            <input type="text" id="cvv" placeholder="XXX">
                                       </div>
                                   </div>
                                   <div>
                                        <label for="cardName">Name on Card</label>
                                        <input type="text" id="cardName" placeholder="Cardholder Name">
                                   </div>
                              </div>

                             <div class="payment-method-option">
                                 <input type="radio" name="paymentMethod" value="upi" id="paymentUpi">
                                 <label for="paymentUpi">UPI (Simulated)</label>
                             </div>
                              <div id="upiDetails" class="space-y-4 pl-6 mt-2 hidden">
                                   <div>
                                       <label for="upiId">UPI ID (Dummy)</label>
                                       <input type="text" id="upiId" placeholder="your_upi_id@bank">
                                   </div>
                                   <div>
                                       <label for="upiApp">Select UPI App</label>
                                       <select id="upiApp">
                                           <option value="">Select App</option>
                                           <option value="gpay">Google Pay</option>
                                           <option value="phonepe">PhonePe</option>
                                           <option value="paytm">Paytm</option>
                                           <option value="other">Other</option>
                                       </select>
                                   </div>
                              </div>

                             <div class="payment-method-option">
                                  <input type="radio" name="paymentMethod" value="cod" id="paymentCod">
                                  <label for="paymentCod">Cash on Delivery (Simulated)</label>
                              </div>
                         </div>
                     </div>
                 </div>


                <div class="mt-6 flex flex-col sm:flex-row gap-3">
                     <button id="modalBackButton" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 px-4 rounded-lg shadow-md transition duration-150 hidden">
                         Back
                     </button>
                     <button id="modalActionButton" class="w-full primary-button font-semibold py-3 px-4 rounded-lg shadow-md transition duration-150">
                         View Cart (<span id="cartItemCount">0</span>) </button>
                </div>
                <p id="modalMessage" class="text-center mt-4 text-sm text-gray-500"></p>
            </div>
        </div>

        <footer class="bg-gray-800 text-white py-8 mt-12">
            <div class="container mx-auto px-4 text-center">
                <p>&copy; 2025 MystiMeal. All rights reserved.</p>
                <p class="text-sm text-gray-400">Saving food, one mystery bag at a time.</p>
            </div>
        </footer>
    </div>

    <script>
        // Sample data for mystery bags and menu items
        const mysteryBagsData = [
            {
                id: 1,
                bagName: "Biryani Surprise",
                restaurantName: "Pista House",
                location: "Hyderabad",
                category: "Biryani", // Specific category
                // You can replace this with an actual image URL for Pista House Biryani
                imageUrl:"https://img.cdn4dd.com/cdn-cgi/image/fit=contain,width=1200,height=672,format=auto/https://doordash-static.s3.amazonaws.com/media/restaurant/cover_square/Pista_House_lo.jpg",
                bagSizes: [
                     { id: 'bag-1-small', size: 'Small', type: 'Small Surprise Biryani Bag', description: 'A smaller portion of surplus biryani.', price: 'â‚¹99' },
                     { id: 'bag-1-medium', size: 'Medium', type: 'Medium Surprise Biryani Bag', description: 'A good portion of surplus biryani.', price: 'â‚¹149' },
                     { id: 'bag-1-large', size: 'Large', type: 'Large Surprise Biryani Bag', description: 'A generous portion of surplus biryani.', price: 'â‚¹199' }
                ],
                availableTimes: [{start: "1:00 PM", end: "3:00 PM"}, {start: "8:00 PM", end: "10:00 PM"}],
                fullMenu: [
                    // Added imageUrl for menu items (using placeholders)
                    {id: 'menu-item-1-1', name: "Chicken Dum Biryani", price: "â‚¹280", imageUrl: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQoIycguxFgTpIN3L00tYQhJ2WkypXj5w_QkQ&s"},
                    {id: 'menu-item-1-2', name: "Mutton Dum Biryani", price: "â‚¹350", imageUrl: "https://placehold.co/80x80/A0522D/FFF7ED?text=Mutton%0ABiryani&font=Roboto"},
                    {id: 'menu-item-1-3', name: "Veg Biryani", price: "â‚¹220", imageUrl: "https://placehold.co/80x80/32CD32/FFF7ED?text=Veg%0ABiryani&font=Roboto"},
                    {id: 'menu-item-1-4', name: "Double Ka Meetha", price: "â‚¹120", imageUrl: "https://placehold.co/80x80/FFB6C1/333?text=Double%0AKa%0AMeetha&font=Roboto"}
                ],
                isHotDeal: true, // Added hot deal flag
                isNewOrTrending: true, // Added new/trending flag
                rating: 4.5, // Added rating
                canBookTable: true, // Can book table here
                cardColor: 'orange' // Color for the card header
            },
            {
                id: 2,
                bagName: "Cafe Bites Box",
                restaurantName: "The Brew Room",
                location: "Hyderabad",
                category: "Cafe", // Specific category
                // You can replace this with an actual image URL for The Brew Room Cafe
                imageUrl: "https://placehold.co/600x400/4682B4/FFF7ED?text=Brew+Room%0ACafe&font=Roboto",
                 bagSizes: [
                     { id: 'bag-2-standard', size: 'Standard', type: 'Breakfast Combo', description: 'A surprise assortment of our popular breakfast items.', price: 'â‚¹99' }
                 ],
                availableTimes: [{start: "9:00 AM", end: "11:00 AM"}],
                fullMenu: [
                    // Added imageUrl for menu items (using placeholders)
                    {id: 'menu-item-2-1', name: "English Breakfast", price: "â‚¹300", imageUrl: "https://placehold.co/80x80/4682B4/FFF7ED?text=English%0ABreakfast&font=Roboto"},
                    {id: 'menu-item-2-2', name: "Pancakes", price: "â‚¹200", imageUrl: "https://placehold.co/80x80/FFC0CB/333?text=Pancakes&font=Roboto"},
                    {id: 'menu-item-2-3', name: "Coffee", price: "â‚¹150", imageUrl: "https://placehold.co/80x80/4682B4/FFF7ED?text=Coffee&font=Roboto"}
                ],
                 isHotDeal: false,
                 isNewOrTrending: true, // Added new/trending flag
                 rating: 4.0, // Added rating
                 canBookTable: true, // Can book table here
                 cardColor: 'green' // Color for the card header
            },
            {
                id: 3,
                bagName: "Sweet Bakery Treats",
                restaurantName: "Sweet Surrender Bakery",
                location: "Hyderabad",
                category: "Bakery", // Specific category
                // You can replace this with an actual image URL for Sweet Surrender Bakery
                imageUrl: "https://placehold.co/600x400/FFC0CB/333?text=Sweet+Surrender%0ABakery&font=Roboto",
                 bagSizes: [
                     { id: 'bag-3-standard', size: 'Standard', type: 'Pastry Assortment', description: 'A delightful selection of leftover pastries.', price: 'â‚¹75' }
                 ],
                availableTimes: [{start: "4:00 PM", end: "6:00 PM"}, {start: "8:00 PM", end: "9:00 PM"}],
                fullMenu: [
                    // Added imageUrl for menu items (using placeholders)
                    {id: 'menu-item-3-1', name: "Chocolate Croissant", price: "â‚¹100", imageUrl: "https://placehold.co/80x80/A0522D/FFF7ED?text=Croissant&font=Roboto"},
                    {id: 'menu-item-3-2', name: "Red Velvet Pastry", price: "â‚¹150", imageUrl: "https://placehold.co/80x80/FFC0CB/333?text=Red%0AVelvet&font=Roboto"},
                    {id: 'menu-item-3-3', name: "Assorted Cookies (Box)", price: "â‚¹250", imageUrl: "https://placehold.co/80x80/FFB6C1/333?text=Cookies&font=Roboto"}
                ],
                 isHotDeal: true, // Added hot deal flag
                 isNewOrTrending: false,
                 rating: 4.8, // Added rating
                 canBookTable: false, // Cannot book table here
                 cardColor: 'pink' // Color for the card header
            },
            {
                id: 4,
                bagName: "Quick Snack Pack",
                restaurantName: "Quick Bites Cafe",
                location: "Hyderabad",
                category: "Fast Food", // Specific category
                // You can replace this with an actual image URL for Quick Bites Cafe
                imageUrl: "https://placehold.co/600x400/32CD32/FFF7ED?text=Quick+Bites%0AFast+Food&font=Roboto",
                 bagSizes: [
                     { id: 'bag-4-standard', size: 'Standard', type: 'Mixed Snacks', description: 'A surprise bag filled with snacks.', price: 'â‚¹60' }
                 ],
                availableTimes: [{start: "3:00 PM", end: "5:00 PM"}],
                fullMenu: [
                    // Added imageUrl for menu items (using placeholders)
                    {id: 'menu-item-4-1', name: "Veg Sandwich", price: "â‚¹80", imageUrl: "https://placehold.co/80x80/32CD32/FFF7ED?text=Sandwich&font=Roboto"},
                    {id: 'menu-item-4-2', name: "French Fries", price: "â‚¹100", imageUrl: "https://placehold.co/80x80/FF8C00/FFF7ED?text=Fries&font=Roboto"},
                    {id: 'menu-item-4-3', name: "Milkshake", price: "â‚¹120", imageUrl: "https://placehold.co/80x80/4682B4/FFF7ED?text=Milkshake&font=Roboto"}
                ],
                 isHotDeal: false,
                 isNewOrTrending: false,
                 rating: 3.9, // Added rating
                 canBookTable: false, // Cannot book table here
                 cardColor: 'orange' // Example color
            },
            {
                id: 5,
                bagName: "Oven Story Pizza Bag",
                restaurantName: "Oven Story Pizza",
                location: "Hyderabad",
                category: "Fast Food", // Specific category
                // You can replace this with an actual image URL for Oven Story Pizza
                imageUrl: "https://placehold.co/600x400/FF4500/FFF7ED?text=Oven+Story%0APizza&font=Roboto",
                 bagSizes: [
                     { id: 'bag-5-standard', size: 'Standard', type: 'Pizza Slice Combo', description: 'Get 2 large surprise slices.', price: 'â‚¹120' }
                 ],
                availableTimes: [{start: "12:00 PM", end: "2:00 PM"}, {start: "7:00 PM", end: "9:00 PM"}],
                fullMenu: [
                    // Added imageUrl for menu items (using placeholders)
                    {id: 'menu-item-5-1', name: "Margherita Pizza", price: "â‚¹250", imageUrl: "https://placehold.co/80x80/FF4500/FFF7ED?text=Margherita&font=Roboto"},
                    {id: 'menu-item-5-2', name: "Farmhouse Pizza", price: "â‚¹350", imageUrl: "https://placehold.co/80x80/32CD32/FFF7ED?text=Farmhouse&font=Roboto"},
                    {id: 'menu-item-5-3', name: "Garlic Bread", price: "â‚¹130", imageUrl: "https://placehold.co/80x80/FF4500/FFF7ED?text=Garlic%0ABread&font=Roboto"}
                ],
                 isHotDeal: true, // Added hot deal flag
                 isNewOrTrending: true, // Added new/trending flag
                 rating: 4.2, // Added rating
                 canBookTable: false, // Cannot book table here
                 cardColor: 'green' // Example color
            },
             {
                id: 6,
                bagName: "Assorted Sweets Box",
                restaurantName: "Gourmet Sweets",
                location: "Hyderabad",
                category: "Sweets", // Specific category
                // You can replace this with an actual image URL for Gourmet Sweets
                imageUrl: "https://placehold.co/600x400/FFB6C1/333?text=Gourmet%0ASweets&font=Roboto",
                 bagSizes: [
                     { id: 'bag-6-small', size: 'Small', type: 'Small Sweets Box', description: 'A small selection of daily leftover sweets.', price: 'â‚¹150' },
                     { id: 'bag-6-large', size: 'Large', type: 'Large Sweets Box', description: 'A larger assortment of fresh sweets.', price: 'â‚¹250' }
                 ],
                availableTimes: [{start: "6:00 PM", end: "8:00 PM"}],
                fullMenu: [
                    // Added imageUrl for menu items (using placeholders)
                    {id: 'menu-item-6-1', name: "Gulab Jamun (4 pcs)", price: "â‚¹100", imageUrl: "https://placehold.co/80x80/FFB6C1/333?text=Gulab%0AJamun&font=Roboto"},
                    {id: 'menu-item-6-2', name: "Rasgulla (4 pcs)", price: "â‚¹100", imageUrl: "https://placehold.co/80x80/FFC0CB/333?text=Rasgulla&font=Roboto"},
                    {id: 'menu-item-6-3', name: "Assorted Barfi (250g)", price: "â‚¹200", imageUrl: "https://placehold.co/80x80/FFB6C1/333?text=Barfi&font=Roboto"}
                ],
                isHotDeal: false,
                isNewOrTrending: false,
                rating: 4.7, // Added rating
                canBookTable: false, // Cannot book table here
                cardColor: 'pink' // Example color
            },
             {
                id: 7,
                bagName: "Curry & Roti Pack",
                restaurantName: "Spice Junction",
                location: "Hyderabad",
                category: "Meals", // General Meals category for other dishes
                // You can replace this with an actual image URL for Spice Junction or Indian Meals
                imageUrl: "https://placehold.co/600x400/A0522D/FFF7ED?text=Spice+Junction%0AMeals&font=Roboto",
                 bagSizes: [
                     { id: 'bag-7-standard', size: 'Standard', type: 'Curry & Roti Surprise', description: 'A surprise curry with rotis.', price: 'â‚¹120' }
                 ],
                availableTimes: [{start: "7:30 PM", end: "9:30 PM"}],
                fullMenu: [
                    // Added imageUrl for menu items (using placeholders)
                    {id: 'menu-item-7-1', name: "Butter Chicken", price: "â‚¹300", imageUrl: "https://placehold.co/80x80/A0522D/FFF7ED?text=Butter%0AChicken&font=Roboto"},
                    {id: 'menu-item-7-2', name: "Dal Makhani", price: "â‚¹250", imageUrl: "https://placehold.co/80x80/333/FFF7ED?text=Dal%0AMakhani&font=Roboto"},
                    {id: 'menu-item-7-3', name: "Naan", price: "â‚¹50", imageUrl: "https://placehold.co/80x80/FF8C00/FFF7ED?text=Naan&font=Roboto"},
                    {id: 'menu-item-7-4', name: "Jeera Rice", price: "â‚¹150", imageUrl: "https://placehold.co/80x80/32CD32/FFF7ED?text=Jeera%0ARice&font=Roboto"}
                ],
                isHotDeal: false,
                isNewOrTrending: true, // Added new/trending flag
                rating: 4.1, // Added rating
                canBookTable: true, // Can book table here
                cardColor: 'orange' // Example color
            }
        ];

         // Sample data for cart suggestions (can be items from other restaurants or popular items)
         const cartSuggestionsData = [
             { id: 101, name: "Garlic Bread", price: "â‚¹130", imageUrl: "https://placehold.co/80x80/FF4500/FFF7ED?text=Garlic+Bread&font=Roboto" },
             { id: 102, name: "Cold Coffee", price: "â‚¹150", imageUrl: "https://placehold.co/80x80/4682B4/FFF7ED?text=Cold+Coffee&font=Roboto" },
             { id: 103, name: "Samosa (2 pcs)", price: "â‚¹50", imageUrl: "https://placehold.co/80x80/32CD32/FFF7ED?text=Samosa&font=Roboto" }
         ];

        // Simulated User Data and Order History (will be stored in localStorage)
        // Check if user data exists in local storage, otherwise use default
        let userData = JSON.parse(localStorage.getItem('mystimealUserData')) || null;

        // Check if order history exists in local storage, otherwise use empty array
        let orderHistory = JSON.parse(localStorage.getItem('mystimealOrderHistory')) || [];

        // Simulated Pending Bookings (will be stored in localStorage)
        let pendingBookings = JSON.parse(localStorage.getItem('mystimealPendingBookings')) || [];


        // Get references to key DOM elements for easier access
        const authScreen = document.getElementById('authScreen'); // Reference to the new auth screen
        const loginView = document.getElementById('loginView'); // Reference to the login view
        const signupView = document.getElementById('signupView'); // Reference to the signup view
        const otpView = document.getElementById('otpView'); // Reference to the OTP view
        const loginPhoneInput = document.getElementById('loginPhone'); // Reference to login phone input
        const loginButton = document.getElementById('loginButton'); // Reference to login button
        const signupNameInput = document.getElementById('signupName'); // Reference to signup name input
        const signupPhoneInput = document.getElementById('signupPhone'); // Reference to signup phone input
        const signupEmailInput = document.getElementById('signupEmail'); // Reference to signup email input
        const signupButton = document.getElementById('signupButton'); // Reference to signup button
        const otpPhoneNumberSpan = document.getElementById('otpPhoneNumber'); // Reference to OTP phone number display
        const otpInputs = document.querySelectorAll('.otp-input'); // References to individual OTP inputs
        const verifyOtpButton = document.getElementById('verifyOtpButton'); // Reference to verify OTP button
        const resendOtpButton = document.getElementById('resendOtpButton'); // Reference to resend OTP button
        const authMessage = document.getElementById('authMessage'); // Reference to auth message paragraph
        const tempOtpDisplay = document.getElementById('tempOtpDisplay'); // Reference to the temporary OTP display element

        // Get references to the auth view switching buttons
        const showSignupBtn = document.getElementById('showSignupBtn');
        const showLoginBtn = document.getElementById('showLoginBtn');


        const mainAppContent = document.getElementById('mainAppContent'); // Reference to the main app content container
        const mainListingView = document.getElementById('mainListingView'); // Reference to the main listing view
        const userAccountScreen = document.getElementById('userAccountScreen'); // Reference to the user account screen
        const orderProgressView = document.getElementById('orderProgressView'); // Reference to the order progress view
        const receiptView = document.getElementById('receiptView'); // Reference to the new receipt view
        const bookingPageView = document.getElementById('bookingPageView'); // Reference to the new booking page view


        const bagListingsContainer = document.getElementById('bagListings');
        const hotDealsSection = document.getElementById('hotDealsSection'); // Reference to hot deals section
        const hotDealsContainer = document.getElementById('hotDealsContainer'); // Reference to hot deals container
        const newTrendingSection = document.getElementById('newTrendingSection'); // Reference to new/trending section
        const newTrendingContainer = document.getElementById('newTrendingContainer'); // Reference to new/trending container

        // Dine & Save elements (now within bookingPageView)
        const dineSaveSection = document.getElementById('dineSaveSection');
        const bookableRestaurantsList = document.getElementById('bookableRestaurantsList'); // Container for bookable restaurant cards
        const bookingForm = document.getElementById('bookingForm'); // The booking form itself
        const selectedBookingRestaurantIdInput = document.getElementById('selectedBookingRestaurantId'); // Hidden input for selected restaurant ID
        const selectedBookingRestaurantNameSpan = document.getElementById('selectedBookingRestaurantName'); // Span to display selected restaurant name in form
        const bookingDateInput = document.getElementById('bookingDate');
        const bookingTimeInput = document.getElementById('bookingTime');
        const bookingGuestsInput = document.getElementById('bookingGuests');
        const tablePreferenceRadios = document.querySelectorAll('input[name="tablePreference"]');
        const confirmBookingButton = document.getElementById('confirmBookingButton');
        const bookingMessage = document.getElementById('bookingMessage');


        const modal = document.getElementById('bagDetailModal');
        const closeModalButton = document.getElementById('closeModalButton');
        const modalRestaurantTitle = document.getElementById('modalRestaurantTitle');
        const modalRestaurantImage = document.getElementById('modalRestaurantImage');
        const modalBagSizesContainer = document.getElementById('modalBagSizes');
        const modalPickupTimesContainer = document.getElementById('modalPickupTimes');
        const modalFullMenuContainer = document.getElementById('modalFullMenu');
        const cartItemsContainer = document.getElementById('cartItems');
        const cartTotalSpan = document.getElementById('cartTotal');
        const modalActionButton = document.getElementById('modalActionButton');
        const modalBackButton = document.getElementById('modalBackButton');
        const cartItemCountSpan = document.getElementById('cartItemCount');
        const modalMessage = document.getElementById('modalMessage');
        const cartSuggestionsContainer = document.getElementById('cartSuggestions'); // Reference to suggestions container
        const modalRestaurantRatingDiv = document.getElementById('modalRestaurantRating'); // Reference to modal rating div


        // References to checkout form elements
        const deliveryOptionRadios = document.querySelectorAll('input[name="deliveryOption"]');
        const deliveryAddressFields = document.getElementById('deliveryAddressFields');
        const addressInput = document.getElementById('address');
        const dropoffTextarea = document.getElementById('dropoff');
        const timeZoneSelect = document.getElementById('timeZone'); // Reference to time zone select
        const pickupTimeSelect = document.getElementById('pickupTime');
        const deliveryPrioritySection = document.getElementById('deliveryPrioritySection'); // Reference to delivery priority section
        const deliveryPriorityRadios = document.querySelectorAll('input[name="deliveryPriority"]');
        const paymentMethodRadios = document.querySelectorAll('input[name="paymentMethod"]');

        // References to dummy payment input fields
        const cardDetailsDiv = document.getElementById('cardDetails');
        const cardNumberInput = document.getElementById('cardNumber');
        const expiryDateInput = document.getElementById('expiryDate');
        const cvvInput = document.getElementById('cvv');
        const cardNameInput = document.getElementById('cardName');
        const upiDetailsDiv = document.getElementById('upiDetails');
        const upiIdInput = document.getElementById('upiId');
        const upiAppSelect = document.getElementById('upiApp');


        // References to user account elements
        const persistentCartContainer = document.getElementById('persistentCartItems');
        const persistentCartItemCountSpan = document.getElementById('persistentCartItemCount');
        const persistentCartActions = document.getElementById('persistentCartActions');
        const pendingBookingsSection = document.getElementById('pendingBookingsSection'); // Reference to pending bookings section
        const pendingBookingsCountSpan = document.getElementById('pendingBookingsCount'); // Reference to pending bookings count
        const pendingBookingsList = document.getElementById('pendingBookingsList'); // Reference to pending bookings list
        const orderHistoryItemsContainer = document.getElementById('orderHistoryItems');
        const profileNameInput = document.getElementById('profileName');
        const profilePhoneInput = document.getElementById('profilePhone');
        const profileEmailInput = document.getElementById('profileEmail');
        const profileAddressInput = document.getElementById('profileAddress');
        const greetingUserNameSpan = document.getElementById('greetingUserName'); // Reference to greeting name

        // References to order progress elements
        const currentOrderIdSpan = document.getElementById('currentOrderId');
        const stepPreparation = document.getElementById('stepPreparation');
        const stepOutForDelivery = document.getElementById('stepOutForDelivery');
        const stepDelivered = document.getElementById('stepDelivered');
        const orderStatusMessage = document.getElementById('orderStatusMessage');

        // References to receipt view elements
        const receiptOrderIdSpan = document.getElementById('receiptOrderId');
        const receiptSummaryDiv = document.getElementById('receiptSummary');
        const receiptItemsDiv = document.getElementById('receiptItems');
        const receiptDeliveryDetailsDiv = document.getElementById('receiptDeliveryDetails');
        const receiptPaymentDetailsDiv = document.getElementById('receiptPaymentDetails');
        const receiptTotalSpan = document.getElementById('receiptTotal');


        // State variables for filtering, searching, and current restaurant data
        let currentCategory = 'All';
        let currentSearchTerm = '';
        let currentRestaurantData = null; // Stores data for the currently open restaurant

        // Simulated Cart: Stores items added from the current modal
        let currentModalCart = {
            bag: null, // Stores the selected surprise bag size object (only one allowed)
            menuItems: [] // Stores an array of menu item objects
        };

        // State variable for the current modal view
        let currentModalView = 'bagMenuDetail'; // Possible values: 'bagMenuDetail', 'cart', 'checkoutAddress', 'checkoutTime', 'checkoutPayment'

        // Simulated OTP
        let simulatedOtp = '';
        let currentAuthPhone = ''; // Store the phone number being authenticated

        // --- Local Storage Functions ---
        function saveCartToLocalStorage() {
            localStorage.setItem('mystimealCart', JSON.stringify(currentModalCart));
             renderPersistentCart(); // Update the persistent cart display
        }

        function loadCartFromLocalStorage() {
            const savedCart = localStorage.getItem('mystimealCart');
            if (savedCart) {
                currentModalCart = JSON.parse(savedCart);
                updateCartItemCount(); // Update modal cart count on load
                 renderPersistentCart(); // Render the loaded cart in the persistent section
            }
        }

        function saveOrderToHistory(order) {
            orderHistory.push(order);
            localStorage.setItem('mystimealOrderHistory', JSON.stringify(orderHistory));
             renderOrderHistory(); // Update the order history display
        }

        function saveUserData() {
             localStorage.setItem('mystimealUserData', JSON.stringify(userData));
             updateGreetingUserName(); // Update the greeting on the main page
        }

         function savePendingBookings() {
             localStorage.setItem('mystimealPendingBookings', JSON.stringify(pendingBookings));
             renderPendingBookings(); // Update the pending bookings display
         }

         function loadPendingBookings() {
             const savedBookings = localStorage.getItem('mystimealPendingBookings');
             if (savedBookings) {
                 pendingBookings = JSON.parse(savedBookings);
                 renderPendingBookings(); // Render the loaded pending bookings
             }
         }


        // --- View Switching Functions ---
        function showAuthScreen() {
            authScreen.classList.remove('hidden');
            mainAppContent.classList.add('hidden');
            userAccountScreen.classList.add('hidden');
            orderProgressView.classList.add('hidden');
            receiptView.classList.add('hidden'); // Hide receipt view
            bookingPageView.classList.add('hidden'); // Hide booking page
            // Show login view by default when showing auth screen
            showLoginView();
        }

        function showLoginView() {
            loginView.classList.add('active');
            signupView.classList.remove('active');
            otpView.classList.remove('active');
             authMessage.textContent = ''; // Clear any previous auth messages
             tempOtpDisplay.classList.add('hidden'); // Hide temp OTP on view switch
        }

        function showSignupView() {
            loginView.classList.remove('active');
            signupView.classList.add('active');
            otpView.classList.remove('active');
             authMessage.textContent = ''; // Clear any previous auth messages
             tempOtpDisplay.classList.add('hidden'); // Hide temp OTP on view switch
        }

         function showOtpView(phone) {
             loginView.classList.remove('active');
             signupView.classList.remove('active');
             otpView.classList.add('active');
             otpPhoneNumberSpan.textContent = '+91 ' + phone; // Display the phone number
             authMessage.textContent = ''; // Clear any previous auth messages
             clearOtpInputs(); // Clear previous OTP inputs
             // tempOtpDisplay.classList.remove('hidden'); // Show temp OTP display when OTP view is active (handled in simulateSendOtp now)
         }


        function showMainAppContent() {
             authScreen.classList.add('hidden');
             mainAppContent.classList.remove('hidden');
             userAccountScreen.classList.add('hidden');
             orderProgressView.classList.add('hidden');
             receiptView.classList.add('hidden'); // Hide receipt view
             bookingPageView.classList.add('hidden'); // Hide booking page
             filterAndRenderBags(); // Render bags when showing main content
             renderHotDeals(); // Render hot deals on home screen
             renderNewOrTrending(); // Render new/trending on home screen
             loadCartFromLocalStorage(); // Load persistent cart
             updateGreetingUserName(); // Update greeting name
             // populateBookingRestaurants(); // No longer needed here, done on booking page load
             // renderBookableRestaurants(); // No longer needed here, done on booking page load
        }

        function showMainListing() {
            mainListingView.classList.remove('hidden');
            userAccountScreen.classList.add('hidden');
            orderProgressView.classList.add('hidden');
            receiptView.classList.add('hidden'); // Hide receipt view
            bookingPageView.classList.add('hidden'); // Hide booking page
        }

        function showUserAccount() {
            mainListingView.classList.add('hidden');
            userAccountScreen.classList.remove('hidden');
            orderProgressView.classList.add('hidden');
            receiptView.classList.add('hidden'); // Hide receipt view
            bookingPageView.classList.add('hidden'); // Hide booking page
             renderOrderHistory(); // Render history when showing account
             renderUserProfile(); // Render profile when showing account
             renderPersistentCart(); // Render persistent cart when showing account
             renderPendingBookings(); // Render pending bookings when showing account
        }

         // New function to show the booking page
         function showBookingPage() {
             mainListingView.classList.add('hidden');
             userAccountScreen.classList.add('hidden');
             orderProgressView.classList.add('hidden');
             receiptView.classList.add('hidden'); // Hide receipt view
             bookingPageView.classList.remove('hidden'); // Show booking page

             renderBookableRestaurants(); // Render bookable restaurants on the booking page
             // Hide the booking form initially on the booking page
             bookingForm.classList.remove('active');
             bookingMessage.textContent = ''; // Clear any previous message
             bookingMessage.className = 'text-center mt-4 text-sm text-gray-500'; // Reset message styling
         }


        function showOrderProgress(orderId) {
            mainListingView.classList.add('hidden');
            userAccountScreen.classList.add('hidden');
            orderProgressView.classList.remove('hidden'); // Ensure order progress view is shown
            receiptView.classList.add('hidden'); // Hide receipt view
            bookingPageView.classList.add('hidden'); // Hide booking page
            currentOrderIdSpan.textContent = orderId;
            // Simulate order progress steps (basic example)
            updateOrderProgressSteps('placed');
            // In a real app, you'd fetch the actual order status and update the steps
        }

         function showReceiptDetails(orderId) {
             mainListingView.classList.add('hidden');
             userAccountScreen.classList.add('hidden');
             orderProgressView.classList.add('hidden');
             receiptView.classList.remove('hidden'); // Show receipt view
             bookingPageView.classList.add('hidden'); // Hide booking page

             const order = orderHistory.find(o => o.id === orderId);
             if (!order) {
                 receiptSummaryDiv.innerHTML = '<p>Order not found.</p>';
                 receiptItemsDiv.innerHTML = '';
                 receiptDeliveryDetailsDiv.innerHTML = '';
                 receiptPaymentDetailsDiv.innerHTML = '';
                 receiptTotalSpan.textContent = 'â‚¹0';
                 receiptOrderIdSpan.textContent = 'N/A';
                 return;
             }

             receiptOrderIdSpan.textContent = order.id;

             // Populate Order Summary
             receiptSummaryDiv.innerHTML = `
                 <p><strong>Restaurant:</strong> ${order.restaurant}</p>
                 <p><strong>Order Date:</strong> ${order.date}</p>
                 <p><strong>Status:</strong> ${order.status.charAt(0).toUpperCase() + order.status.slice(1)}</p>
             `;

             // Populate Items Ordered
             receiptItemsDiv.innerHTML = '';
             // Check if the order is a dine-in booking or a bag/menu item order
             if (order.items && order.items.message) {
                 receiptItemsDiv.innerHTML = `<p>${order.items.message}</p>`; // Display the message for dine-in bookings
             } else {
                 if (order.items.bag) {
                      // Display image for the bag in the receipt
                      const bagRestaurant = mysteryBagsData.find(r => r.id === order.items.bag.id); // Assuming bag.id matches restaurant id
                      const bagImageUrl = bagRestaurant ? bagRestaurant.imageUrl : 'https://placehold.co/40x40/eee/333?text=Bag';
                      receiptItemsDiv.innerHTML += `
                          <div class="receipt-item-details">
                              <img src="${bagImageUrl}" alt="${order.items.bag.bagName}">
                              <div class="item-info">
                                  <span>${order.items.bag.bagName} (${order.items.bag.size})</span>
                                  <span class="price">${order.items.bag.price}</span>
                              </div>
                          </div>
                      `;
                 }
                 if (order.items.menuItems && order.items.menuItems.length > 0) {
                     order.items.menuItems.forEach(item => {
                         // Display image for menu items in the receipt
                          const itemImageUrl = item.imageUrl || 'https://placehold.co/40x40/eee/333?text=Item'; // Use item's image or a placeholder
                         receiptItemsDiv.innerHTML += `
                             <div class="receipt-item-details">
                                  <img src="${itemImageUrl}" alt="${item.name}">
                                  <div class="item-info">
                                      <span>${item.name} (Qty: ${item.quantity || 1})</span>
                                      <span class="price">${item.price}</span>
                                  </div>
                             </div>
                         `;
                     });
                 }
                  if (!order.items.bag && (!order.items.menuItems || order.items.menuItems.length === 0)) {
                      receiptItemsDiv.innerHTML = '<p>No items listed.</p>';
                  }
             }


             // Populate Delivery/Pickup Details
             receiptDeliveryDetailsDiv.innerHTML = `
                 <p><strong>Option:</strong> ${order.deliveryOption ? (order.deliveryOption.charAt(0).toUpperCase() + order.deliveryOption.slice(1)) : 'N/A'}</p>
             `;
             if (order.deliveryOption === 'delivery') {
                 receiptDeliveryDetailsDiv.innerHTML += `
                     <p><strong>Address:</strong> ${order.address || 'N/A'}</p>
                     <p><strong>Dropoff Instructions:</strong> ${order.dropoff || 'None'}</p>
                     <p><strong>Priority:</strong> ${order.deliveryPriority ? (order.deliveryPriority.charAt(0).toUpperCase() + order.deliveryPriority.slice(1)) : 'N/A'}</p>
                 `;
             } else if (order.deliveryOption === 'booking') { // Handle dine-in booking details
                  receiptDeliveryDetailsDiv.innerHTML = `
                      <p><strong>Type:</strong> Dine-in Booking</p>
                      <p><strong>Date:</strong> ${order.date || 'N/A'}</p>
                      <p><strong>Time:</strong> ${order.time || 'N/A'}</p>
                      <p><strong>Guests:</strong> ${order.guests || 'N/A'}</p>
                      <p><strong>Table Preference:</strong> ${order.tablePreference === 'small' ? 'Small Gathering' : (order.tablePreference === 'large' ? 'Large Table' : 'N/A')}</p>
                  `;
             }
              receiptDeliveryDetailsDiv.innerHTML += `
                  <p><strong>Preferred Time:</strong> ${order.preferredTime || 'Any'}</p>
                  <p><strong>Time Zone:</strong> ${order.timeZone || 'N/A'}</p>
              `;


             // Populate Payment Information
             receiptPaymentDetailsDiv.innerHTML = `
                 <p><strong>Method:</strong> ${order.paymentMethod ? (order.paymentMethod.charAt(0).toUpperCase() + order.paymentMethod.slice(1)) : 'N/A'}</p>
             `;
             if (order.paymentMethod === 'card' && order.paymentDetails && order.paymentDetails.card) {
                 // Mask card number for display
                 const maskedCardNumber = order.paymentDetails.card.number ? '**** **** **** ' + order.paymentDetails.card.number.slice(-4) : 'N/A';
                 receiptPaymentDetailsDiv.innerHTML += `
                     <p><strong>Card Number:</strong> ${maskedCardNumber}</p>
                     <p><strong>Expiry Date:</strong> ${order.paymentDetails.card.expiry || 'N/A'}</p>
                     <p><strong>Cardholder Name:</strong> ${order.paymentDetails.card.name || 'N/A'}</p>
                 `;
             } else if (order.paymentMethod === 'upi' && order.paymentDetails && order.paymentDetails.upi) {
                  receiptPaymentDetailsDiv.innerHTML += `
                      <p><strong>UPI ID:</strong> ${order.paymentDetails.upi.id || 'N/A'}</p>
                      <p><strong>UPI App:</strong> ${order.paymentDetails.upi.app || 'N/A'}</p>
                  `;
             } else if (order.paymentMethod === 'cod') {
                  receiptPaymentDetailsDiv.innerHTML += `<p>Payment will be collected on delivery.</p>`;
             } else if (order.paymentMethod === 'Simulated Post-Meal Payment') {
                  receiptPaymentDetailsDiv.innerHTML += `<p>${order.paymentDetails.message || 'Payment processed.'}</p>`;
             }
             else {
                  receiptPaymentDetailsDiv.innerHTML += `<p>Payment details not available.</p>`;
             }


             // Populate Total
             receiptTotalSpan.textContent = `â‚¹${order.total}`;
         }


        // --- Authentication Logic (Simulated) ---
        loginButton.addEventListener('click', () => {
            const phone = loginPhoneInput.value.trim();
            currentAuthPhone = phone; // Store phone number
            // In a real app, you'd send this to a backend for authentication
            // For this simulation, we'll just check if user data exists
            if (userData && userData.phone === '+91 ' + phone) {
                 // Simulate sending OTP
                 simulateSendOtp(phone);
                 showOtpView(phone); // Show OTP verification view
            } else {
                 authMessage.textContent = 'Invalid phone number or user not found. Please sign up.';
                 authMessage.className = 'text-center mt-4 text-sm text-yellow-600';
                 setTimeout(() => { authMessage.textContent = ''; authMessage.className = 'text-center mt-4 text-sm text-gray-500'; }, 3000);
            }
        });

        signupButton.addEventListener('click', () => {
            const name = signupNameInput.value.trim();
            const phone = signupPhoneInput.value.trim();
            const email = signupEmailInput.value.trim();

            if (!name || !phone) {
                authMessage.textContent = 'Name and Phone Number are required for signup.';
                authMessage.className = 'text-center mt-4 text-sm text-yellow-600';
                setTimeout(() => { authMessage.textContent = ''; authMessage.className = 'text-center mt-4 text-sm text-gray-500'; }, 3000);
                return;
            }

             currentAuthPhone = phone; // Store phone number

            // In a real app, you'd send this to a backend to create a new user and send OTP
            // For this simulation, we'll create a new user object (but not save yet) and simulate sending OTP
            const newUser = {
                name: name,
                phone: '+91 ' + phone, // Store with country code for consistency
                email: email,
                address: '' // Default empty address
            };

             // Simulate sending OTP
             simulateSendOtp(phone);
             showOtpView(phone); // Show OTP verification view

             // Store new user data temporarily until OTP is verified
             sessionStorage.setItem('tempNewUser', JSON.stringify(newUser));

            // Clear signup form fields
            signupNameInput.value = '';
            signupPhoneInput.value = '';
            signupEmailInput.value = '';
        });

         verifyOtpButton.addEventListener('click', () => {
             const enteredOtp = Array.from(otpInputs).map(input => input.value).join('');
             // In a real app, you'd send the phone and entered OTP to the backend for verification
             // For this simulation, we compare with the simulated OTP
             if (enteredOtp === simulatedOtp) {
                 authMessage.textContent = 'OTP verified successfully!';
                 authMessage.className = 'text-center mt-4 text-sm text-green-600';

                 // Hide the temporary OTP display on successful verification
                 tempOtpDisplay.classList.add('hidden');

                 // If there's temporary new user data, save it as the current user
                 const tempNewUser = sessionStorage.getItem('tempNewUser');
                 if (tempNewUser) {
                     userData = JSON.parse(tempNewUser);
                     saveUserData(); // Save the new user permanently
                     sessionStorage.removeItem('tempNewUser'); // Clear temporary data
                 } else {
                      // If no temporary user, assume it was a login attempt and user data is already loaded
                      // (In a real app, successful login verification would load user data)
                 }


                 setTimeout(() => {
                     authMessage.textContent = '';
                     authMessage.className = 'text-center mt-4 text-sm text-gray-500';
                     showMainAppContent(); // Show main app content on successful verification
                 }, 1000);
             } else {
                 authMessage.textContent = 'Invalid OTP. Please try again.';
                 authMessage.className = 'text-center mt-4 text-sm text-yellow-600';
                 clearOtpInputs(); // Clear OTP inputs on failure
                  // Keep the temporary OTP displayed for retry
                 setTimeout(() => { authMessage.textContent = ''; authMessage.className = 'text-center mt-4 text-sm text-gray-500'; }, 3000);
             }
         });

         resendOtpButton.addEventListener('click', () => {
             // Simulate resending OTP using the stored phone number
             if (currentAuthPhone) {
                 simulateSendOtp(currentAuthPhone);
                 authMessage.textContent = 'OTP resent!';
                 authMessage.className = 'text-center mt-4 text-sm text-green-600';
                 clearOtpInputs(); // Clear inputs for new OTP
                 setTimeout(() => { authMessage.textContent = ''; authMessage.className = 'text-center mt-4 text-sm text-gray-500'; }, 2000);
             } else {
                  authMessage.textContent = 'Please enter your phone number first.';
                  authMessage.className = 'text-center mt-4 text-sm text-yellow-600';
                  setTimeout(() => { authMessage.textContent = ''; authMessage.className = 'text-center mt-4 text-sm text-gray-500'; }, 3000);
             }
         });


         // Simulate sending an OTP (client-side)
         function simulateSendOtp(phone) {
             // Generate a random 4-digit OTP
             simulatedOtp = Math.floor(1000 + Math.random() * 9000).toString();
             console.log(`Simulated OTP for +91 ${phone}: ${simulatedOtp}`); // Log OTP to console for testing

             // Display the simulated OTP on the screen
             tempOtpDisplay.textContent = `Temporary OTP: ${simulatedOtp} (Simulated)`;
             tempOtpDisplay.classList.remove('hidden'); // Show the display element

             authMessage.textContent = `OTP sent to +91 ${phone}.`; // Update message to remove console instruction
             authMessage.className = 'text-center mt-4 text-sm text-green-600';
         }

         // Clear OTP input fields and hide the temporary OTP display
         function clearOtpInputs() {
             otpInputs.forEach(input => input.value = '');
             if (otpInputs.length > 0) {
                 otpInputs[0].focus(); // Focus on the first input
             }
             // Keep the temporary OTP displayed when inputs are cleared (e.g., on failed verification)
             // tempOtpDisplay.classList.add('hidden'); // Hide temporary OTP display
         }

         // Auto-focus and move to the next OTP input
         otpInputs.forEach((input, index) => {
             input.addEventListener('input', () => {
                 if (input.value.length === input.maxLength) {
                     const nextInput = otpInputs[index + 1];
                     if (nextInput) {
                         nextInput.focus();
                     }
                 }
             });
             input.addEventListener('keydown', (event) => {
                 if (event.key === 'Backspace' && input.value.length === 0) {
                     const prevInput = otpInputs[index - 1];
                     if (prevInput) {
                         prevInput.focus();
                     }
                 }
             });
         });


        // --- Filtering and Rendering ---
        function filterAndRenderBags() {
            console.log("filterAndRenderBags started."); // Debug log
            console.log("mysteryBagsData:", mysteryBagsData); // Debug log: Check if data is loaded

            let filteredBags = mysteryBagsData;

            // Filter by category if a specific category is selected (excluding "Restaurants" which shows all)
            if (currentCategory !== 'All' && currentCategory !== 'Restaurants') {
                 filteredBags = filteredBags.filter(bag => bag.category === currentCategory);
            } else if (currentCategory === 'Restaurants') {
                 // If "Restaurants" is selected, show all items (they are all from restaurants)
                 filteredBags = mysteryBagsData;
            }


            // Filter by search term if the search input is not empty
            if (currentSearchTerm) {
                const lowerSearchTerm = currentSearchTerm.toLowerCase();
                filteredBags = filteredBags.filter(bag =>
                    bag.bagName.toLowerCase().includes(lowerSearchTerm) ||
                    bag.restaurantName.toLowerCase().includes(lowerSearchTerm)
                );
            }

            console.log("Filtered bags:", filteredBags); // Debug log: Check filtered data

            // Clear previous listings from the container
            bagListingsContainer.innerHTML = '';

            // Display a message if no bags are found after filtering/searching
            if (filteredBags.length === 0) {
                console.log("No filtered bags found. Displaying message."); // Debug log
                bagListingsContainer.innerHTML = `<p class="col-span-full text-center text-gray-500">No surprise bags found matching your criteria.</p>`;
                return;
            }

            // Render the filtered bags using the ORIGINAL card structure
            console.log("Rendering filtered bags..."); // Debug log
            filteredBags.forEach(bag => {
                console.log("Rendering bag:", bag); // Debug log: Log each bag being rendered

                 // Generate star rating HTML
                 const starRatingHtml = generateStarRating(bag.rating);

                const card = `
                    <div class="restaurant-card flex flex-col cursor-pointer" onclick="showBagDetails(${bag.id})">
                        <img src="${bag.imageUrl}" alt="${bag.bagName}">
                        <div class="card-content">
                            <h3 class="text-lg font-semibold text-gray-800 mb-1">${bag.restaurantName}</h3>
                            <div class="rating-container">${starRatingHtml}</div>
                             <p class="restaurant-name text-sm text-gray-500 mb-2">${bag.bagName} - <span class="text-xs bg-orange-100 text-orange-600 font-medium px-2 py-0.5 rounded-full">${bag.category}</span></p>
                             <p class="price text-2xl font-bold text-FF6B00 my-2">${bag.bagSizes.length > 1 ? `${bag.bagSizes[0].price} - ${bag.bagSizes[bag.bagSizes.length - 1].price}` : bag.bagSizes[0].price}</p>
                            <p class="bag-info text-gray-500 text-xs mb-3 flex-grow">${bag.description ? bag.description.substring(0, 70) + '...' : 'No description available.'}</p>
                            <button class="view-details-button font-semibold transition duration-150 text-sm">
                                View Details
                            </button>
                        </div>
                    </div>
                `;
                bagListingsContainer.innerHTML += card;
            });
             console.log("filterAndRenderBags finished."); // Debug log
        }

        // Function to render Hot Deals (keeping previous logic and card style)
        function renderHotDeals() {
            const hotDeals = mysteryBagsData.filter(bag => bag.isHotDeal);
            hotDealsContainer.innerHTML = ''; // Clear previous hot deals

            if (hotDeals.length > 0) {
                hotDealsSection.classList.remove('hidden'); // Show the hot deals section
                hotDeals.forEach(deal => {
                    const dealCard = `
                        <div class="hot-deal-card flex flex-col cursor-pointer" onclick="showBagDetails(${deal.id})">
                            <img src="${deal.imageUrl}" alt="${deal.bagName}">
                            <div class="deal-content">
                                <span class="deal-tag">Hot Deal!</span>
                                <h4>${deal.restaurantName}</h4>
                                <p>${deal.bagName}</p>
                                <p class="deal-price">${deal.bagSizes[0].price}</p>
                            </div>
                        </div>
                    `;
                    hotDealsContainer.innerHTML += dealCard;
                });
            } else {
                hotDealsSection.classList.add('hidden'); // Hide if no hot deals
            }
        }

        // Function to render New or Trending items (keeping previous logic and card style)
        function renderNewOrTrending() {
             const newTrendingItems = mysteryBagsData.filter(bag => bag.isNewOrTrending);
             newTrendingContainer.innerHTML = ''; // Clear previous items

             if (newTrendingItems.length > 0) {
                 newTrendingSection.classList.remove('hidden'); // Show the section
                 newTrendingItems.forEach(item => {
                     const itemCard = `
                         <div class="new-trending-card flex flex-col cursor-pointer" onclick="showBagDetails(${item.id})">
                             <img src="${item.imageUrl}" alt="${item.bagName}">
                             <div class="deal-content">
                                 <span class="deal-tag">New & Trending!</span>
                                 <h4>${item.restaurantName}</h4>
                                 <p>${item.bagName}</p>
                                 <p class="deal-price">${item.bagSizes[0].price}</p>
                             </div>
                         </div>
                     `;
                     newTrendingContainer.innerHTML += itemCard;
                 });
             } else {
                 newTrendingSection.classList.add('hidden'); // Hide if no new/trending items
             }
        }

         // Function to generate star rating HTML (used in modal and main cards)
         function generateStarRating(rating) {
             if (rating === undefined || rating === null) {
                 return ''; // Return empty string if no rating
             }
             const fullStars = Math.floor(rating);
             const halfStar = rating % 1 !== 0;
             const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);

             let starsHtml = '';
             for (let i = 0; i < fullStars; i++) {
                 starsHtml += '<i class="fas fa-star"></i>';
             }
             if (halfStar) {
                 starsHtml += '<i class="fas fa-star-half-alt"></i>';
             }
             for (let i = 0; i < emptyStars; i++) {
                 starsHtml += '<i class="far fa-star"></i>'; // Use far for empty star outline
             }

             return `
                 <div class="rating">
                     <div class="stars">${starsHtml}</div>
                     <span class="rating-text">${rating.toFixed(1)}</span>
                 </div>
             `;
         }


        // --- Modal and Cart Functions ---
        // Function to show restaurant details in the modal (keeping previous logic and modal appearance)
        window.showBagDetails = function(bagId) {
            const bag = mysteryBagsData.find(b => b.id === bagId);
            if (bag) {
                currentRestaurantData = bag; // Store the data for the currently open restaurant

                // Reset the modal cart and set the initial view
                currentModalCart = {
                    bag: null,
                    menuItems: []
                };
                switchModalView('bagMenuDetail'); // Start with the bag/menu view
                updateModalButtons(); // Update buttons based on the initial empty cart state
                updateCartItemCount(); // Update cart count display

                // Populate modal with restaurant details
                modalRestaurantTitle.textContent = bag.restaurantName;
                modalRestaurantImage.src = bag.imageUrl;
                modalRestaurantImage.alt = bag.restaurantName;

                // Display rating in the modal
                modalRestaurantRatingDiv.innerHTML = generateStarRating(bag.rating);


                // Populate bag size options for the restaurant
                modalBagSizesContainer.innerHTML = '';
                if (bag.bagSizes && bag.bagSizes.length > 0) {
                    bag.bagSizes.forEach(bagSize => {
                        // Pass only the bag size ID to the addToCart function
                        const bagSizeHtml = `
                            <div class="flex justify-between items-center bag-size-item">
                                <div>
                                    <p class="font-semibold text-gray-800">${bag.bagName} (${bagSize.size})</p>
                                    <p class="text-xs text-gray-600">${bagSize.description}</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <p class="text-lg font-bold text-FF6B00">${bagSize.price}</p>
                                    <button class="add-to-cart-btn" onclick="addToCart('bag', '${bagSize.id}')">Add</button>
                                </div>
                            </div>
                        `;
                        modalBagSizesContainer.innerHTML += bagSizeHtml;
                    });
                } else {
                     modalBagSizesContainer.innerHTML = `<p class="text-gray-500">No surprise bags available for this restaurant.</p>`;
                }

                // Populate available pickup times
                modalPickupTimesContainer.innerHTML = '';
                if (bag.availableTimes && bag.availableTimes.length > 0) {
                     bag.availableTimes.forEach(time => {
                         const timeChip = `<span class="bg-green-100 text-green-700 text-xs font-semibold px-2.5 py-1 rounded-full">${time.start} - ${time.end}</span>`;
                         modalPickupTimesContainer.innerHTML += timeChip;
                     });
                } else {
                     modalPickupTimesContainer.innerHTML = `<p class="text-gray-500">No specific pickup times listed.</p>`;
                }

                // Populate the full menu with "Add" buttons and images for each item
                modalFullMenuContainer.innerHTML = '';
                if (bag.fullMenu && bag.fullMenu.length > 0) {
                    bag.fullMenu.forEach(item => {
                         const itemImageUrl = item.imageUrl || 'https://placehold.co/80x80/eee/333?text=Item'; // Use item's image or a placeholder
                         // Pass only the menu item ID to the addToCart function
                        const menuItemHtml = `
                            <div class="flex justify-between menu-item">
                                <div class="flex items-center gap-3">
                                     <img src="${itemImageUrl}" alt="${item.name}" class="w-12 h-12 object-cover rounded-md">
                                     <span>${item.name}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span>${item.price}</span>
                                    <button class="add-to-cart-btn" onclick="addToCart('menuItem', '${item.id}')">Add</button>
                                </div>
                            </div>
                        `;
                        modalFullMenuContainer.innerHTML += menuItemHtml;
                    });
                } else {
                    modalFullMenuContainer.innerHTML = `<p>Full menu details not available for this listing.</p>`;
                }

                // Show the modal with animation
                modal.classList.remove('opacity-0', 'pointer-events-none');
                modal.querySelector('.modal-content').classList.remove('scale-95');
                modal.querySelector('.modal-content').classList.add('scale-100');
            }
        }

        // Function to switch between the different views within the modal (keeping previous logic)
        function switchModalView(view) {
            // Hide all modal views
            bagMenuDetailView.classList.remove('active');
            cartView.classList.remove('active');
            checkoutAddressView.classList.remove('active');
            checkoutTimeView.classList.remove('active');
            checkoutPaymentView.classList.remove('active');

            // Show the requested view and manage back button visibility
            if (view === 'bagMenuDetail') {
                bagMenuDetailView.classList.add('active');
                modalBackButton.classList.add('hidden'); // No back button on the main detail view
            } else if (view === 'cart') {
                cartView.classList.add('active');
                modalBackButton.classList.remove('hidden'); // Show back button
                modalBackButton.onclick = () => switchModalView('bagMenuDetail'); // Back button goes to bag/menu view
                renderCartItems(); // Render cart items when navigating to the cart view
                renderCartSuggestions(); // Render suggestions when navigating to the cart view
            } else if (view === 'checkoutAddress') {
                 checkoutAddressView.classList.add('active');
                 modalBackButton.classList.remove('hidden');
                 modalBackButton.onclick = () => switchModalView('cart'); // Back button goes to cart
                 // Ensure delivery address fields visibility is correct based on initial radio state
                 updateDeliveryAddressFieldsVisibility();
            } else if (view === 'checkoutTime') {
                 checkoutTimeView.classList.add('active');
                 modalBackButton.classList.remove('hidden');
                 modalBackButton.onclick = () => switchModalView('checkoutAddress'); // Back button goes to address
                 populateTimeOptions(); // Populate time options based on delivery/pickup selection
                 updateDeliveryPriorityVisibility(); // Update delivery priority visibility
            } else if (view === 'checkoutPayment') {
                 checkoutPaymentView.classList.add('active');
                 modalBackButton.classList.remove('hidden');
                 modalBackButton.onclick = () => switchModalView('checkoutTime'); // Back button goes to time
                 // Ensure dummy payment fields visibility is correct based on initial radio state
                 updateDummyPaymentFieldsVisibility();
            }

            currentModalView = view; // Update the state variable for the current view
            updateModalButtons(); // Update action buttons based on the new view
        }

        // Function to add items (bag size or menu item) to the simulated cart (keeping previous logic)
        function addToCart(itemType, itemId) {
            let itemToAdd = null;

            if (!currentRestaurantData) {
                console.error("currentRestaurantData is not set.");
                return;
            }

            if (itemType === 'bag') {
                // Find the bag size by ID from the current restaurant's bagSizes
                itemToAdd = currentRestaurantData.bagSizes.find(bagSize => bagSize.id === itemId);
                // Allow only one surprise bag in the cart for simplicity
                if (!currentModalCart.bag && itemToAdd) {
                    currentModalCart.bag = { ...itemToAdd, quantity: 1 }; // Add quantity property
                    modalMessage.textContent = `${currentRestaurantData.bagName} (${itemToAdd.size}) added to cart!`;
                    modalMessage.className = 'text-center mt-4 text-sm text-green-600';
                     // You could add logic here to disable or change the "Add" buttons for other bag sizes
                } else if (currentModalCart.bag) {
                     modalMessage.textContent = `Only one surprise bag allowed in the cart at a time.`;
                     modalMessage.className = 'text-center mt-4 text-sm text-yellow-600';
                } else {
                     console.error(`Bag size with ID ${itemId} not found.`);
                     modalMessage.textContent = `Error adding item to cart.`;
                     modalMessage.className = 'text-center mt-4 text-sm text-red-600';
                }
            } else if (itemType === 'menuItem') {
                 // Find the menu item by ID from the current restaurant's fullMenu
                 itemToAdd = currentRestaurantData.fullMenu.find(menuItem => menuItem.id === itemId);
                 if (itemToAdd) {
                     // Check if the menu item is already in the cart (simple check by ID)
                     const existingItemIndex = currentModalCart.menuItems.findIndex(i => i.id === itemToAdd.id);
                     if (existingItemIndex === -1) {
                        // Add new menu item with quantity 1
                        currentModalCart.menuItems.push({ ...itemToAdd, quantity: 1 });
                        modalMessage.textContent = `${itemToAdd.name} added to cart!`;
                        modalMessage.className = 'text-center mt-4 text-sm text-green-600';
                     } else {
                        // Increase quantity of existing menu item
                        currentModalCart.menuItems[existingItemIndex].quantity++;
                        modalMessage.textContent = `${itemToAdd.name} quantity increased!`;
                        modalMessage.className = 'text-center mt-4 text-sm text-green-600';
                     }
                 } else {
                     console.error(`Menu item with ID ${itemId} not found.`);
                     modalMessage.textContent = `Error adding item to cart.`;
                     modalMessage.className = 'text-center mt-4 text-sm text-red-600';
                 }
            } else {
                 console.error(`Unknown item type: ${itemType}`);
                 modalMessage.textContent = `Error adding item to cart.`;
                 modalMessage.className = 'text-center mt-4 text-sm text-red-600';
            }


            updateModalButtons(); // Update the state of the action buttons
            updateCartItemCount(); // Update the number shown on the "View Cart" button
            saveCartToLocalStorage(); // Save cart state to local storage
            renderCartItems(); // Re-render cart to show updated quantities/items

            // Clear the message after a short delay
            setTimeout(() => {
                modalMessage.textContent = '';
                modalMessage.className = 'text-center mt-4 text-sm text-gray-500'; // Reset message styling
            }, 2000);
        }

        // Function to increase the quantity of a menu item in the cart (keeping previous logic)
        window.increaseQuantity = function(itemId) {
            const itemIndex = currentModalCart.menuItems.findIndex(item => item.id === itemId);
            if (itemIndex !== -1) {
                currentModalCart.menuItems[itemIndex].quantity++;
                saveCartToLocalStorage();
                renderCartItems();
                updateCartItemCount();
            }
        }

        // Function to decrease the quantity of a menu item in the cart (keeping previous logic)
        window.decreaseQuantity = function(itemId) {
            const itemIndex = currentModalCart.menuItems.findIndex(item => item.id === itemId);
            if (itemIndex !== -1) {
                if (currentModalCart.menuItems[itemIndex].quantity > 1) {
                    currentModalCart.menuItems[itemIndex].quantity--;
                    saveCartToLocalStorage();
                    renderCartItems();
                    updateCartItemCount();
                } else {
                    // If quantity is 1, remove the item
                    removeFromCart('menuItem', itemId);
                }
            }
        }


         // Function to remove an item from the simulated cart (keeping previous logic)
         function removeFromCart(itemType, itemId) {
             if (itemType === 'bag') {
                 currentModalCart.bag = null; // Remove the bag
                 modalMessage.textContent = `Surprise bag removed from cart.`;
             } else if (itemType === 'menuItem') {
                 // Filter out the item with the matching ID
                 currentModalCart.menuItems = currentModalCart.menuItems.filter(item => item.id !== itemId);
                 modalMessage.textContent = `Item removed from cart.`;
             }
             modalMessage.className = 'text-center mt-4 text-sm text-green-600';
             renderCartItems(); // Re-render the cart display
             updateModalButtons(); // Update action buttons
             updateCartItemCount(); // Update cart count
             saveCartToLocalStorage(); // Save updated cart state

             // Clear the message after a short delay
             setTimeout(() => {
                 modalMessage.textContent = '';
                 modalMessage.className = 'text-center mt-4 text-sm text-gray-500'; // Reset message styling
             }, 2000);
         }

        // Function to update the text, style, and visibility of modal action buttons based on current view and cart state (keeping previous logic)
        function updateModalButtons() {
            const hasBag = currentModalCart.bag !== null;
            const hasMenuItems = currentModalCart.menuItems.length > 0;
            const totalItems = (hasBag ? 1 : 0) + currentModalCart.menuItems.reduce((sum, item) => sum + item.quantity, 0);


            // Reset button classes and state to a default inactive style
            modalActionButton.classList.remove('primary-button', 'secondary-button', 'warning-button');
            modalActionButton.classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-800');
            modalActionButton.disabled = false; // Enable by default, disable specifically below if needed

            // Logic to set button text, style, and action based on the current modal view
            if (currentModalView === 'bagMenuDetail') {
                modalBackButton.classList.add('hidden'); // Hide back button on the main detail view
                if (totalItems === 0) {
                     modalActionButton.textContent = 'View Cart (0)';
                     modalActionButton.disabled = true; // Disable if cart is empty
                } else {
                    modalActionButton.textContent = `View Cart (${totalItems})`;
                    modalActionButton.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-800');
                    modalActionButton.classList.add('primary-button'); // Use primary style when cart has items
                    modalActionButton.disabled = false;
                }
                // The action button always navigates to the cart view from here
                modalActionButton.onclick = () => switchModalView('cart');

            } else if (currentModalView === 'cart') {
                 modalBackButton.classList.remove('hidden'); // Show back button
                 modalBackButton.onclick = () => switchModalView('bagMenuDetail'); // Back button goes to bag/menu view

                 if (totalItems === 0) {
                     modalActionButton.textContent = 'Cart Empty';
                     modalActionButton.disabled = true; // Disable if cart is empty
                 } else {
                     modalActionButton.textContent = 'Proceed to Checkout';
                     modalActionButton.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-800');
                     modalActionButton.classList.add('primary-button');
                     modalActionButton.disabled = false;
                     // The action button proceeds to the address step of checkout
                     modalActionButton.onclick = () => switchModalView('checkoutAddress');
                 }

            } else if (currentModalView === 'checkoutAddress') {
                 modalBackButton.classList.remove('hidden');
                 modalBackButton.onclick = () => switchModalView('cart'); // Back button goes to cart

                 modalActionButton.textContent = 'Continue to Time';
                 modalActionButton.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-800');
                 modalActionButton.classList.add('primary-button');
                 // The action button proceeds to the time step
                 modalActionButton.onclick = () => switchModalView('checkoutTime');

            } else if (currentModalView === 'checkoutTime') {
                 modalBackButton.classList.remove('hidden');
                 modalBackButton.onclick = () => switchModalView('checkoutAddress'); // Back button goes to address

                 modalActionButton.textContent = 'Continue to Payment';
                 modalActionButton.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-800');
                 modalActionButton.classList.add('primary-button');
                 // The action button proceeds to the payment step
                 modalActionButton.onclick = () => switchModalView('checkoutPayment');

            } else if (currentModalView === 'checkoutPayment') {
                 modalBackButton.classList.remove('hidden');
                 modalBackButton.onclick = () => switchModalView('checkoutTime'); // Back button goes to time

                 modalActionButton.textContent = 'Place Final Order';
                 modalActionButton.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-800');
                 modalActionButton.classList.add('secondary-button'); // Use secondary style for the final action
                 // The action button triggers the final order simulation
                 modalActionButton.onclick = () => handleFinalOrder();
            }
        }

        // Function to update the item count displayed on the "View Cart" button (keeping previous logic)
        function updateCartItemCount() {
            const totalItems = (currentModalCart.bag ? 1 : 0) + currentModalCart.menuItems.reduce((sum, item) => sum + item.quantity, 0);
            cartItemCountSpan.textContent = totalItems;
        }

        // Function to render the items currently in the simulated cart (keeping previous logic)
        function renderCartItems() {
            cartItemsContainer.innerHTML = ''; // Clear previous cart items
            let total = 0;

            // Render the surprise bag if present
            if (currentModalCart.bag) {
                const bag = currentModalCart.bag;
                const bagPrice = parseFloat(bag.price.replace('â‚¹', '')); // Parse price string to number
                total += bagPrice;
                 // Display image for the bag in the cart
                 const bagRestaurant = mysteryBagsData.find(r => r.id === bag.id); // Assuming bag.id matches restaurant id for simplicity
                 const bagImageUrl = bagRestaurant ? bagRestaurant.imageUrl : 'https://placehold.co/80x80/eee/333?text=Bag';
                const bagItemHtml = `
                    <div class="flex justify-between items-center border-b pb-2">
                        <div class="flex items-center gap-3">
                             <img src="${bagImageUrl}" alt="${bag.bagName}" class="w-12 h-12 object-cover rounded-md">
                             <div>
                                 <p class="font-semibold text-gray-800">${currentRestaurantData.restaurantName} - ${bag.bagName} (${bag.size})</p>
                                 <p class="text-xs text-gray-600">${bag.type}</p>
                             </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <p class="text-base font-bold text-FF6B00">${bag.price}</p>
                            <button class="remove-item-btn" onclick="removeFromCart('bag', '${bag.id}')">Remove</button>
                        </div>
                    </div>
                `;
                cartItemsContainer.innerHTML += bagItemHtml;
            }

            // Render the menu items if any are present
            if (currentModalCart.menuItems.length > 0) {
                 currentModalCart.menuItems.forEach(item => {
                     const itemPrice = parseFloat(item.price.replace('â‚¹', '')); // Parse price string to number
                     const itemTotal = itemPrice * item.quantity; // Calculate total for this item
                     total += itemTotal;
                      const itemImageUrl = item.imageUrl || 'https://placehold.co/80x80/eee/333?text=Item'; // Use item's image or a placeholder
                     const menuItemHtml = `
                         <div class="flex justify-between items-center border-b pb-2">
                             <div class="flex items-center gap-3">
                                  <img src="${itemImageUrl}" alt="${item.name}" class="w-12 h-12 object-cover rounded-md">
                                  <p class="text-gray-700">${currentRestaurantData.restaurantName} - ${item.name}</p>
                             </div>
                             <div class="flex items-center gap-2">
                                 <div class="cart-item-quantity">
                                     <button class="quantity-button" onclick="decreaseQuantity('${item.id}')" ${item.quantity <= 1 ? 'disabled' : ''}>-</button>
                                     <span>${item.quantity}</span>
                                     <button class="quantity-button" onclick="increaseQuantity('${item.id}')">+</button>
                                 </div>
                                 <p class="text-base text-gray-600">â‚¹${itemTotal.toFixed(2)}</p>
                                 <button class="remove-item-btn" onclick="removeFromCart('menuItem', '${item.id}')">Remove</button>
                             </div>
                         </div>
                     `;
                     cartItemsContainer.innerHTML += menuItemHtml;
                 });
            }

            // Display a message if the cart is empty
            if (!currentModalCart.bag && currentModalCart.menuItems.length === 0) {
                cartItemsContainer.innerHTML = `<p class="text-center text-gray-500">Your cart is empty.</p>`;
            }

            // Update the displayed total price
            cartTotalSpan.textContent = `Total: â‚¹${total.toFixed(2)}`; // Display total with 2 decimal places
        }

        // Function to render suggested items in the cart view (keeping previous logic)
        function renderCartSuggestions() {
            cartSuggestionsContainer.innerHTML = ''; // Clear previous suggestions
            // Only show suggestions if the cart is not empty
            if (currentModalCart.bag || currentModalCart.menuItems.length > 0) {
                 const suggestionsTitle = document.createElement('h4');
                 suggestionsTitle.textContent = 'You might also like:';
                 cartSuggestionsContainer.appendChild(suggestionsTitle);

                 cartSuggestionsData.forEach(suggestion => {
                      // Pass only the suggestion ID to the addToCart function
                     const suggestionHtml = `
                         <div class="suggestion-item">
                             <div class="item-details">
                                 <img src="${suggestion.imageUrl}" alt="${suggestion.name}">
                                 <div class="item-info">
                                     <span>${suggestion.name}</span>
                                     <span class="price">${suggestion.price}</span>
                                 </div>
                             </div>
                             <button class="add-button" onclick="addToCart('menuItem', '${suggestion.id}')">Add</button>
                         </div>
                     `;
                     cartSuggestionsContainer.innerHTML += suggestionHtml;
                 });
            }
        }


        // Function to populate the pickup time options in the checkout time view (keeping previous logic)
        function populateTimeOptions() {
            pickupTimeSelect.innerHTML = ''; // Clear previous options
            const selectedDeliveryOption = document.querySelector('input[name="deliveryOption"]:checked').value;

            if (selectedDeliveryOption === 'pickup') {
                 if (currentRestaurantData && currentRestaurantData.availableTimes.length > 0) {
                     currentRestaurantData.availableTimes.forEach(time => {
                         const option = document.createElement('option');
                         option.value = `${time.start}-${time.end}`;
                         option.textContent = `${time.start} - ${time.end} (Surprise Bag Pickup)`;
                         pickupTimeSelect.appendChild(option);
                     });
                 } else {
                     const option = document.createElement('option');
                     option.value = 'any';
                     option.textContent = 'Any available pickup time';
                     pickupTimeSelect.appendChild(option);
                 }
            } else if (selectedDeliveryOption === 'delivery') {
                 // Simulate delivery time windows (can be more sophisticated)
                 const deliveryTimes = [
                     "Within 30-45 minutes",
                     "Within 1 hour",
                     "Within 1-1.5 hours"
                 ];
                 deliveryTimes.forEach(time => {
                     const option = document.createElement('option');
                     option.value = time;
                     option.textContent = time;
                     pickupTimeSelect.appendChild(option);
                 });
            }
        }

        // Function to handle the final order placement (simulated checkout process) (keeping previous logic)
        function handleFinalOrder() {
            const hasBag = currentModalCart.bag !== null;
            const hasMenuItems = currentModalCart.menuItems.length > 0;

            // Prevent placing an order if the cart is empty
            if (!hasBag && !hasMenuItems) {
                 modalMessage.textContent = 'Your cart is empty. Cannot place order.';
                 modalMessage.className = 'text-center mt-4 text-sm text-yellow-600';
                 return;
            }

            // Simulate collecting checkout details from form inputs
            const selectedDeliveryOption = document.querySelector('input[name="deliveryOption"]:checked').value;
            const address = addressInput.value.trim();
            const dropoff = dropoffTextarea.value.trim();
            const timeZone = timeZoneSelect.value;
            const preferredTime = pickupTimeSelect.value;
            const selectedDeliveryPriority = document.querySelector('input[name="deliveryPriority"]:checked')?.value;
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;

            // Basic validation: Address is required for delivery
            if (selectedDeliveryOption === 'delivery' && !address) {
                 modalMessage.textContent = 'Please enter a delivery address for delivery orders.';
                 modalMessage.className = 'text-center mt-4 text-sm text-yellow-600';
                 return;
            }
             // Basic validation: Payment method is required
             if (!paymentMethod) {
                 modalMessage.textContent = 'Please select a payment method.';
                 modalMessage.className = 'text-center mt-4 text-sm text-yellow-600';
                 return;
             }

            // Capture dummy payment details based on selected method
            let paymentDetails = {};
            if (paymentMethod === 'card') {
                 paymentDetails.card = {
                     number: cardNumberInput.value.trim(),
                     expiry: expiryDateInput.value.trim(),
                     cvv: cvvInput.value.trim(),
                     name: cardNameInput.value.trim()
                 };
                 // Basic dummy validation for card fields
                 if (!paymentDetails.card.number || !paymentDetails.card.expiry || !paymentDetails.card.cvv || !paymentDetails.card.name) {
                      modalMessage.textContent = 'Please fill in all dummy card details.';
                      modalMessage.className = 'text-center mt-4 text-sm text-yellow-600';
                      return;
                 }
            } else if (paymentMethod === 'upi') {
                 paymentDetails.upi = {
                     id: upiIdInput.value.trim(),
                     app: upiAppSelect.value
                 };
                 // Basic dummy validation for UPI fields
                 if (!paymentDetails.upi.id || !paymentDetails.upi.app) {
                     modalMessage.textContent = 'Please fill in dummy UPI ID and select an app.';
                     modalMessage.className = 'text-center mt-4 text-sm text-yellow-600';
                     return;
                 }
            }


            // Construct a simulated order object
            const newOrder = {
                id: orderHistory.length + 1, // Simple incremental ID
                restaurant: currentRestaurantData.restaurantName,
                items: {
                    bag: currentModalCart.bag,
                    menuItems: currentModalCart.menuItems
                },
                deliveryOption: selectedDeliveryOption,
                address: selectedDeliveryOption === 'delivery' ? address : 'N/A',
                dropoff: selectedDeliveryOption === 'delivery' ? dropoff : 'N/A',
                timeZone: timeZone,
                preferredTime: preferredTime,
                deliveryPriority: selectedDeliveryOption === 'delivery' ? selectedDeliveryPriority : 'N/A',
                paymentMethod: paymentMethod,
                paymentDetails: paymentDetails, // Save the captured dummy payment details
                total: cartTotalSpan.textContent.replace('Total: â‚¹', ''), // Capture the total price
                date: new Date().toLocaleDateString(), // Add current date
                status: 'placed' // Initial status
            };

            saveOrderToHistory(newOrder); // Save the new order to history

            // Simulate clearing the current modal cart and closing the modal
            currentModalCart = { bag: null, menuItems: [] };
            updateCartItemCount();
            saveCartToLocalStorage(); // Clear persistent cart

            // Reset checkout form fields and dummy payment fields
            addressInput.value = '';
            dropoffTextarea.value = '';
            document.getElementById('optionPickup').checked = true;
            document.getElementById('priorityRegular').checked = true;
            updateDeliveryAddressFieldsVisibility();
            updateDeliveryPriorityVisibility();
            populateTimeOptions(); // Reset time options
            document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => radio.checked = false);
            cardNumberInput.value = '';
            expiryDateInput.value = '';
            cvvInput.value = '';
            cardNameInput.value = '';
            upiIdInput.value = '';
            upiAppSelect.value = '';
            updateDummyPaymentFieldsVisibility(); // Hide dummy fields


            // Show the order progress view for the new order
            closeModal(); // Close the checkout modal
            showOrderProgress(newOrder.id); // Show the order progress view

             // Simulate sending order confirmation message
             if (userData && userData.phone) {
                 // In a real app, this would be an API call to send an SMS
                 console.log(`Simulating Order Confirmation SMS to ${userData.phone} for Order #${newOrder.id}`);
                 // Display a temporary message to the user
                 const confirmationMessage = `Order #${newOrder.id} placed successfully! Confirmation sent to ${userData.phone}.`;
                 // Using alert for simplicity in this simulation
                 alert(confirmationMessage);
             }


             // Simulate order status updates over time (basic example)
             // These timeouts will trigger the animation by adding the 'completed' class
             setTimeout(() => { updateOrderProgressSteps('preparing'); }, 3000); // After 3 seconds
             setTimeout(() => { updateOrderProgressSteps('out'); }, 8000); // After 8 seconds
             setTimeout(() => { updateOrderProgressSteps('delivered'); }, 15000); // After 15 seconds

        }

        // Function to close the modal and reset its state (keeping previous logic)
        function closeModal() {
            // Hide the modal with animation
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.add('scale-95');
            modal.querySelector('.modal-content').classList.remove('scale-100');
            // Clear any message displayed in the modal
             modalMessage.textContent = '';
             modalMessage.className = 'text-center mt-4 text-sm text-gray-500'; // Reset message styling
             // Reset modal cart and view state (Note: Persistent cart is handled separately)
             // currentModalCart = { bag: null, menuItems: [] }; // Don't clear modal cart here, it's handled on order placement or modal open
             currentModalView = 'bagMenuDetail'; // Reset to the initial bag/menu view
             updateModalButtons(); // Update buttons based on the reset state
             // updateCartItemCount(); // Don't reset cart count here, it reflects the persistent cart now
             currentRestaurantData = null; // Clear the stored restaurant data

             // Reset checkout form fields and dummy payment fields
             addressInput.value = '';
             dropoffTextarea.value = '';
             document.getElementById('optionPickup').checked = true;
             document.getElementById('priorityRegular').checked = true;
             updateDeliveryAddressFieldsVisibility();
             updateDeliveryPriorityVisibility();
             populateTimeOptions(); // Reset time options
             document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => radio.checked = false);
             cardNumberInput.value = '';
             expiryDateInput.value = '';
             cvvInput.value = '';
             cardNameInput.value = '';
             upiIdInput.value = '';
             upiAppSelect.value = '';
             updateDummyPaymentFieldsVisibility(); // Hide dummy fields
        }

        // Add event listeners to close the modal (keeping previous logic)
        closeModalButton.addEventListener('click', closeModal);
        // Close modal if clicking outside the modal content area
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal();
            }
        });
        // Close modal if the Escape key is pressed
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && !modal.classList.contains('pointer-events-none')) {
                closeModal();
            }
        });

        // Add event listener for the Back button in the modal (keeping previous logic)
        modalBackButton.addEventListener('click', () => {
            // Navigate back to the previous view based on the current view
            if (currentModalView === 'cart') {
                switchModalView('bagMenuDetail');
            } else if (currentModalView === 'checkoutAddress') {
                switchModalView('cart');
            } else if (currentModalView === 'checkoutTime') {
                switchModalView('checkoutAddress');
            } else if (currentModalView === 'checkoutPayment') {
                switchModalView('checkoutTime');
            }
        });

        // Function to toggle visibility of delivery address fields based on delivery option (keeping previous logic)
        function updateDeliveryAddressFieldsVisibility() {
            const selectedDeliveryOption = document.querySelector('input[name="deliveryOption"]:checked').value;
            if (selectedDeliveryOption === 'delivery') {
                deliveryAddressFields.classList.remove('hidden');
            } else {
                deliveryAddressFields.classList.add('hidden');
            }
        }

        // Function to toggle visibility of delivery priority section based on delivery option (keeping previous logic)
        function updateDeliveryPriorityVisibility() {
             const selectedDeliveryOption = document.querySelector('input[name="deliveryOption"]:checked').value;
             if (selectedDeliveryOption === 'delivery') {
                 deliveryPrioritySection.classList.remove('hidden');
             } else {
                 deliveryPrioritySection.classList.add('hidden');
             }
        }

        // Function to toggle visibility of dummy payment input fields based on selected payment method (keeping previous logic)
        function updateDummyPaymentFieldsVisibility() {
             const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;

             cardDetailsDiv.classList.add('hidden');
             upiDetailsDiv.classList.add('hidden');

             if (selectedPaymentMethod === 'card') {
                 cardDetailsDiv.classList.remove('hidden');
             } else if (selectedPaymentMethod === 'upi') {
                 upiDetailsDiv.classList.remove('hidden');
             }
        }


        // Add event listeners to the delivery option radio buttons (moved inside DOMContentLoaded)
        deliveryOptionRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                updateDeliveryAddressFieldsVisibility();
                updateDeliveryPriorityVisibility();
                populateTimeOptions(); // Repopulate time options based on selection
            });
        });

         // Add event listeners to the payment method radio buttons (moved inside DOMContentLoaded)
         paymentMethodRadios.forEach(radio => {
             radio.addEventListener('change', updateDummyPaymentFieldsVisibility);
         });


        // --- User Account Functions (keeping previous logic) ---
        function renderPersistentCart() {
            persistentCartContainer.innerHTML = ''; // Clear previous items
            const hasBag = currentModalCart.bag !== null;
            const hasMenuItems = currentModalCart.menuItems.length > 0;
            const totalItems = (hasBag ? 1 : 0) + currentModalCart.menuItems.reduce((sum, item) => sum + item.quantity, 0);


            persistentCartItemCountSpan.textContent = totalItems;

            if (totalItems === 0) {
                persistentCartContainer.innerHTML = `<p class="text-center text-gray-500">Your persistent cart is empty.</p>`;
                persistentCartActions.classList.add('hidden');
            } else {
                 persistentCartActions.classList.remove('hidden');
                 if (hasBag) {
                     const bag = currentModalCart.bag;
                     // Find the restaurant data for the bag to get the image URL
                     const bagRestaurant = mysteryBagsData.find(r => r.id === bag.id); // Assuming bag.id matches restaurant id for simplicity
                      const bagItemHtml = `
                         <div class="persistent-cart-item">
                             <div class="item-details">
                                 <img src="${bagRestaurant ? bagRestaurant.imageUrl : 'https://placehold.co/50x50/eee/333?text=Bag'}" alt="${bag.bagName}">
                                 <div class="item-info">
                                     <span>${bagRestaurant ? bagRestaurant.restaurantName + ' - ' : ''}${bag.bagName} (${bag.size})</span>
                                     <span class="price">${bag.price}</span>
                                 </div>
                             </div>
                         </div>
                     `;
                     persistentCartContainer.innerHTML += bagItemHtml;
                 }
                 if (hasMenuItems) {
                     currentModalCart.menuItems.forEach(item => {
                          // Find the restaurant data for the menu item (assuming it's from the same restaurant as the bag if a bag exists, otherwise need to store restaurant ID with menu item)
                          const itemRestaurant = currentRestaurantData || (currentModalCart.bag ? mysteryBagsData.find(r => r.id === currentModalCart.bag.id) : null); // Simplified
                           const itemImageUrl = item.imageUrl || 'https://placehold.co/50x50/eee/333?text=Item'; // Use item's image or a placeholder
                          const menuItemHtml = `
                             <div class="persistent-cart-item">
                                 <div class="item-details">
                                     <img src="${itemImageUrl}" alt="${item.name}">
                                     <div class="item-info">
                                         <span>${itemRestaurant ? itemRestaurant.restaurantName + ' - ' : ''}${item.name} (Qty: ${item.quantity})</span>
                                         <span class="price">â‚¹${(parseFloat(item.price.replace('â‚¹', '')) * item.quantity).toFixed(2)}</span>
                                     </div>
                                 </div>
                             </div>
                         `;
                         persistentCartContainer.innerHTML += menuItemHtml;
                     });
                 }
            }
        }

        function continueWithPersistentCart() {
            // This function would typically navigate back to the restaurant's detail page
            // with the cart pre-populated. For this simulation, we'll just close the account view
            // and the items are already in currentModalCart due to loadCartFromLocalStorage.
            showMainListing();
             closeModal(); // Close the modal if it was open
             // You might want to automatically open the modal to the cart view here
             // if the user was in the middle of checkout before leaving.
        }

        function clearPersistentCart() {
            currentModalCart = { bag: null, menuItems: [] };
            saveCartToLocalStorage(); // Clear from local storage
            renderPersistentCart(); // Update display
            updateCartItemCount(); // Reset modal cart count
             modalMessage.textContent = 'Persistent cart cleared.';
             modalMessage.className = 'text-center mt-4 text-sm text-green-600';
             setTimeout(() => { modalMessage.textContent = ''; modalMessage.className = 'text-center mt-4 text-sm text-gray-500'; }, 2000);
        }

         function renderPendingBookings() {
             pendingBookingsList.innerHTML = ''; // Clear previous bookings
             pendingBookingsCountSpan.textContent = pendingBookings.length;

             if (pendingBookings.length === 0) {
                 pendingBookingsList.innerHTML = `<p class="text-center text-gray-500">No pending bookings.</p>`;
             } else {
                 // Sort bookings by ID in descending order (most recent first)
                 const sortedPendingBookings = [...pendingBookings].sort((a, b) => b.id - a.id);

                 sortedPendingBookings.forEach(booking => {
                     const bookingHtml = `
                         <div class="pending-booking-item">
                             <div class="booking-details">
                                 <p><strong>Restaurant:</strong> ${booking.restaurantName}</p>
                                 <p><strong>Date:</strong> ${booking.date}</p>
                                 <p><strong>Time:</strong> ${booking.time}</p>
                                 <p><strong>Guests:</strong> ${booking.guests}</p>
                                 <p><strong>Table Preference:</strong> ${booking.tablePreference === 'small' ? 'Small Gathering' : 'Large Table'}</p>
                             </div>
                             <div class="pending-booking-actions" id="booking-actions-${booking.id}">
                                 ${booking.billAmount !== undefined ? // Check if billAmount is defined
                                     `<span class="bill-amount">Bill: â‚¹${booking.billAmount.toFixed(2)}</span>
                                      <button class="pay-now-button" onclick="simulatePayment(${booking.id})">Pay Now</button>`
                                     :
                                     `<button class="receive-bill-button" onclick="simulateReceiveBill(${booking.id})">Simulate Receive Bill</button>
                                      <button class="cancel-button" onclick="cancelBooking(${booking.id})">Cancel Booking</button>`
                                 }
                             </div>
                         </div>
                     `;
                     pendingBookingsList.innerHTML += bookingHtml;
                 });
             }
         }

         window.simulateReceiveBill = function(bookingId) {
             const bookingIndex = pendingBookings.findIndex(b => b.id === bookingId);
             if (bookingIndex !== -1) {
                 // Simulate a random bill amount (e.g., between 500 and 3000)
                 const dummyBillAmount = Math.random() * (3000 - 500) + 500;
                 // Apply a simulated discount (e.g., 15%)
                 const discountedBill = dummyBillAmount * 0.85; // 15% discount
                 pendingBookings[bookingIndex].billAmount = discountedBill;
                 savePendingBookings(); // Save updated bookings
                 renderPendingBookings(); // Re-render the list to show the bill and Pay Now button
                 alert(`Simulating bill received for booking #${bookingId}. Bill amount: â‚¹${discountedBill.toFixed(2)} (Includes 15% discount).`);
             }
         }

         window.simulatePayment = function(bookingId) {
             const bookingIndex = pendingBookings.findIndex(b => b.id === bookingId);
              if (bookingIndex !== -1 && pendingBookings[bookingIndex].billAmount !== undefined) {
                  // Simulate payment success
                  const completedBooking = {
                      ...pendingBookings[bookingIndex],
                      status: 'completed', // Mark as completed
                      total: pendingBookings[bookingIndex].billAmount.toFixed(2), // Use the bill amount as total
                      date: new Date().toLocaleDateString(), // Add completion date
                       // Add placeholder payment details for the receipt
                       paymentMethod: 'Simulated Post-Meal Payment',
                       paymentDetails: { message: 'Payment processed after dining.' },
                       items: { message: 'Dine-in booking, items not listed in this receipt type.' }, // Indicate this is a dine-in receipt
                       restaurant: pendingBookings[bookingIndex].restaurantName, // Add restaurant name for receipt
                       deliveryOption: 'booking' // Indicate this was a booking
                  };

                  saveOrderToHistory(completedBooking); // Move to order history
                  pendingBookings.splice(bookingIndex, 1); // Remove from pending bookings
                  savePendingBookings(); // Save updated pending bookings
                  renderPendingBookings(); // Update pending bookings display
                  renderOrderHistory(); // Update order history display

                  alert(`Simulating payment for booking #${bookingId}. Payment successful!`);
                  // Optionally, show the receipt view for this booking
                  // showReceiptDetails(completedBooking.id); // Need to adjust receipt view to handle booking data
              } else {
                  alert('Cannot simulate payment. Bill not received or booking not found.');
              }
         }

         window.cancelBooking = function(bookingId) {
             const bookingIndex = pendingBookings.findIndex(b => b.id === bookingId);
             if (bookingIndex !== -1) {
                 // Simulate cancelling the booking
                 const cancelledBooking = {
                     ...pendingBookings[bookingIndex],
                     status: 'cancelled', // Mark as cancelled
                     date: new Date().toLocaleDateString(), // Add cancellation date
                     total: '0', // Total is 0 for cancelled booking
                      // Add placeholder details for the receipt
                      paymentMethod: 'N/A',
                      paymentDetails: { message: 'Booking cancelled.' },
                      items: { message: 'Booking cancelled, no items ordered.' },
                      restaurant: pendingBookings[bookingIndex].restaurantName, // Add restaurant name for receipt
                      deliveryOption: 'booking' // Indicate this was a booking
                 };
                 saveOrderToHistory(cancelledBooking); // Move to order history
                 pendingBookings.splice(bookingIndex, 1); // Remove from pending bookings
                 savePendingBookings(); // Save updated pending bookings
                 renderPendingBookings(); // Update pending bookings display
                 renderOrderHistory(); // Update order history display
                 alert(`Booking #${bookingId} has been cancelled.`);
             }
         }


        function renderOrderHistory() {
            orderHistoryItemsContainer.innerHTML = ''; // Clear previous history
            if (orderHistory.length === 0) {
                 orderHistoryItemsContainer.innerHTML = `<p class="text-center text-gray-500">No past orders found.</p>`;
            } else {
                // Sort orders by ID in descending order (most recent first)
                const sortedOrderHistory = [...orderHistory].sort((a, b) => b.id - a.id);

                sortedOrderHistory.forEach(order => {
                    let itemSummary = '';
                    // Check if the order is a dine-in booking or a bag/menu item order
                     if (order.items && order.items.message) {
                         itemSummary = order.items.message; // Use the message for dine-in bookings
                     } else {
                         if (order.items.bag) {
                             itemSummary += `${order.items.bag.bagName} (${order.items.bag.size})`;
                         }
                         if (order.items.menuItems && order.items.menuItems.length > 0) {
                             if (itemSummary) itemSummary += ', ';
                             itemSummary += order.items.menuItems.map(item => `${item.name} (Qty: ${item.quantity || 1})`).join(', ');
                         }
                     }


                    const orderHtml = `
                        <div class="order-item">
                            <div class="order-header">
                                <span class="restaurant-name">${order.restaurant}</span>
                                <span class="order-date">${order.date}</span>
                            </div>
                             <div class="order-details">
                                 Items: ${itemSummary || 'N/A'}
                             </div>
                             <div class="flex justify-between items-center mt-2">
                                 <span class="order-total">Total: â‚¹${order.total}</span>
                                 <span class="order-status ${order.status}">${order.status.charAt(0).toUpperCase() + order.status.slice(1)}</span>
                             </div>
                             <div class="flex justify-end mt-2">
                                  <button class="view-receipt-button" onclick="showReceiptDetails(${order.id})">View Receipt</button>
                             </div>
                        </div>
                    `;
                    orderHistoryItemsContainer.innerHTML += orderHtml;
                });
            }
        }

        function renderUserProfile() {
            profileNameInput.value = userData.name;
            profilePhoneInput.value = userData.phone;
            profileEmailInput.value = userData.email;
            profileAddressInput.value = userData.address;
        }

        function saveProfile() {
            userData.name = profileNameInput.value;
            userData.phone = profilePhoneInput.value;
            userData.email = profileEmailInput.value;
            userData.address = profileAddressInput.value;
            saveUserData(); // Save updated user data
            modalMessage.textContent = 'Profile saved successfully!';
            modalMessage.className = 'text-center mt-4 text-sm text-green-600';
            setTimeout(() => { modalMessage.textContent = ''; modalMessage.className = 'text-center mt-4 text-sm text-gray-500'; }, 2000);
        }

        function updateGreetingUserName() {
            if (userData && userData.name) {
                greetingUserNameSpan.textContent = userData.name;
            } else {
                greetingUserNameSpan.textContent = 'User'; // Default if no user data or name
            }
        }

        // Function to handle user sign out
        function signOut() {
            userData = null; // Clear user data
            localStorage.removeItem('mystimealUserData'); // Remove from local storage
            currentModalCart = { bag: null, menuItems: [] }; // Clear current cart
            localStorage.removeItem('mystimealCart'); // Clear persistent cart
            orderHistory = []; // Clear order history (optional, can keep history)
            localStorage.removeItem('mystimealOrderHistory'); // Remove history from local storage
            pendingBookings = []; // Clear pending bookings
            localStorage.removeItem('mystimealPendingBookings'); // Remove pending bookings from local storage
            showAuthScreen(); // Go back to the authentication screen
            alert('You have been signed out.'); // Provide feedback
        }


        // --- Order Progress Functions (keeping previous logic) ---
        function updateOrderProgressSteps(status) {
            // Reset all steps to not completed
            stepPreparation.classList.remove('completed');
            stepOutForDelivery.classList.remove('completed');
            stepDelivered.classList.remove('completed');
            orderStatusMessage.textContent = '';

            if (status === 'placed') {
                 orderStatusMessage.textContent = 'Order has been placed.';
            } else if (status === 'preparing') {
                stepPreparation.classList.add('completed');
                orderStatusMessage.textContent = 'The restaurant is preparing your order.';
            } else if (status === 'out') {
                stepPreparation.classList.add('completed');
                stepOutForDelivery.classList.add('completed');
                 orderStatusMessage.textContent = 'Your order is out for delivery/ready for pickup.';
            } else if (status === 'delivered') {
                stepPreparation.classList.add('completed');
                stepOutForDelivery.classList.add('completed');
                stepDelivered.classList.add('completed');
                 orderStatusMessage.textContent = 'Order delivered/picked up!';
            }
            // In a real app, you'd also update the status text within each step
        }


        // --- Table Booking Functions ---
        // Function to populate the restaurant dropdown (now only used internally by selectBookingRestaurant)
        function populateBookingRestaurants() {
             // This function is no longer needed to populate a visible dropdown.
             // The selection is now made by clicking the cards.
             // We keep the function but it doesn't do anything visible.
             console.log("populateBookingRestaurants called (internal use).");
        }


         // Function to render bookable restaurants with the new card style
         function renderBookableRestaurants() {
             bookableRestaurantsList.innerHTML = ''; // Clear previous listings
             const bookableRestaurants = mysteryBagsData.filter(bag => bag.canBookTable);

             if (bookableRestaurants.length === 0) {
                 bookableRestaurantsList.innerHTML = `<p class="col-span-full text-center text-gray-500">No restaurants available for booking.</p>`;
             } else {
                 bookableRestaurants.forEach(restaurant => {
                     const cardColorClass = restaurant.cardColor ? `data-color="${restaurant.cardColor}"` : '';
                     const cardHtml = `
                         <div class="bookable-restaurant-card flex flex-col" data-restaurant-id="${restaurant.id}">
                              <div class="card-header" ${cardColorClass}>
                                  <span class="discount-tag">Book Now!</span>
                                  <h3>${restaurant.restaurantName}</h3>
                                  <p>${restaurant.location}</p>
                              </div>
                             <div class="card-content">
                                  <p class="category-content">${restaurant.category}</p>
                                  <p class="price-content">Get 10-20% Off</p>
                                  <button class="unlock-deal-button font-semibold transition duration-150">
                                      Select for Booking
                                  </button>
                                 <p class="tap-card-info">Tap card to select</p>
                             </div>
                         </div>
                     `;
                     bookableRestaurantsList.innerHTML += cardHtml;
                 });

                 // Add event listeners to the newly rendered cards
                 document.querySelectorAll('.bookable-restaurant-card').forEach(card => {
                     card.addEventListener('click', function() {
                         const restaurantId = parseInt(this.dataset.restaurantId);
                         selectBookingRestaurant(restaurantId);
                     });
                 });
             }
         }

         // Function to select a restaurant for booking when its card is clicked
         window.selectBookingRestaurant = function(restaurantId) {
             console.log("Selecting restaurant for booking:", restaurantId); // Debug log
             const selectedRestaurant = mysteryBagsData.find(r => r.id === restaurantId);

             if (selectedRestaurant) {
                 // Set the selected restaurant ID and name in the hidden input and span
                 selectedBookingRestaurantIdInput.value = restaurantId;
                 selectedBookingRestaurantNameSpan.textContent = selectedRestaurant.restaurantName;

                 // Highlight the selected card
                 document.querySelectorAll('.bookable-restaurant-card').forEach(card => {
                     card.classList.remove('selected-for-booking'); // Remove highlight from others
                 });
                 const selected = document.querySelector(`.bookable-restaurant-card[data-restaurant-id="${restaurantId}"]`);
                 if (selected) {
                     selected.classList.add('selected-for-booking'); // Add highlight to the selected card
                     console.log("Highlighted selected card."); // Debug log
                 }

                 // Show the booking form
                 bookingForm.classList.add('active');
                 console.log("Booking form shown after selection."); // Debug log

                 // Set default date and time to today and a reasonable time
                 const now = new Date();
                 const year = now.getFullYear();
                 const month = (now.getMonth() + 1).toString().padStart(2, '0');
                 const day = now.getDate().toString().padStart(2, '0');
                 const hours = now.getHours().toString().padStart(2, '0');
                 const minutes = now.getMinutes().toString().padStart(2, '0');

                 bookingDateInput.value = `${year}-${month}-${day}`;
                 bookingTimeInput.value = `${hours}:${minutes}`;
                 console.log("Default date and time set."); // Debug log


                 // Scroll to the booking form details after selection (optional)
                 const bookingDetailsHeader = document.querySelector('#bookingForm h4'); // Select the "Booking Details" header
                 if (bookingDetailsHeader) {
                     bookingDetailsHeader.scrollIntoView({ behavior: 'smooth', block: 'start' });
                     console.log("Scrolled to booking details."); // Debug log
                 } else {
                     console.log("Could not find booking details header to scroll."); // Debug log
                 }

             } else {
                 console.error("Selected restaurant not found:", restaurantId);
                 bookingMessage.textContent = 'Error selecting restaurant.';
                 bookingMessage.className = 'text-center mt-4 text-sm text-red-600';
                 // Hide the form if selection fails
                 bookingForm.classList.remove('active');
             }
         }

         // Renamed toggleBookingForm to showBookingPage and adjusted its logic
         function showBookingPageSection() {
             console.log("showBookingPageSection called."); // Debug log
             showBookingPage(); // Call the function to switch to the booking page view
         }


         function handleConfirmBooking() {
             console.log("handleConfirmBooking called."); // Debug log
             const selectedRestaurantId = parseInt(selectedBookingRestaurantIdInput.value); // Get ID from hidden input
             const bookingDate = bookingDateInput.value;
             const bookingTime = bookingTimeInput.value;
             const numberOfGuests = parseInt(bookingGuestsInput.value);
             const tablePreference = document.querySelector('input[name="tablePreference"]:checked').value;

             if (!selectedRestaurantId || !bookingDate || !bookingTime || !numberOfGuests) {
                 bookingMessage.textContent = 'Please fill in all booking details.';
                 bookingMessage.className = 'text-center mt-4 text-sm text-yellow-600';
                 console.log("Validation failed: Missing booking details."); // Debug log
                 return;
             }

             const bookedRestaurant = mysteryBagsData.find(r => r.id === selectedRestaurantId);

             if (!bookedRestaurant) {
                 bookingMessage.textContent = 'Selected restaurant not found.';
                 bookingMessage.className = 'text-center mt-4 text-sm text-red-600';
                 console.log("Validation failed: Selected restaurant not found."); // Debug log
                 return;
             }

             // Create a simulated booking object
             const newBooking = {
                 id: pendingBookings.length + 1, // Simple incremental ID for bookings
                 restaurantName: bookedRestaurant.restaurantName,
                 date: bookingDate,
                 time: bookingTime,
                 guests: numberOfGuests,
                 tablePreference: tablePreference,
                 status: 'pending', // Initial status
                 billAmount: undefined, // Bill amount is unknown initially
                 deliveryOption: 'booking' // Add a type to distinguish from delivery orders
             };

             pendingBookings.push(newBooking); // Add to pending bookings
             savePendingBookings(); // Save pending bookings to local storage
             console.log("New booking added:", newBooking); // Debug log

             bookingMessage.textContent = `Booking confirmed for ${bookedRestaurant.restaurantName} on ${bookingDate} at ${bookingTime} for ${numberOfGuests} guests.`;
             bookingMessage.className = 'text-center mt-4 text-sm text-green-600';
             console.log("Booking confirmation message displayed."); // Debug log

             // Hide the booking form after successful booking
             setTimeout(() => {
                 bookingForm.classList.remove('active'); // Hide the form
                 bookingMessage.textContent = ''; // Clear the message
                 bookingMessage.className = 'text-center mt-4 text-sm text-gray-500'; // Reset message styling
                 console.log("Booking form hidden after delay."); // Debug log
                 // Optionally, navigate to the user account page to show pending bookings
                 showUserAccount();
             }, 3000);

             // Clear form fields and remove highlight from selected card
             selectedBookingRestaurantIdInput.value = ''; // Clear selected restaurant ID
             selectedBookingRestaurantNameSpan.textContent = ''; // Clear selected restaurant name display
             // bookingDateInput.value = ''; // Keep date/time for potential multiple bookings? Or clear? Let's clear for now.
             // bookingTimeInput.value = '';
             bookingGuestsInput.value = '1';
             document.getElementById('tablePreference-small').checked = true; // Reset table preference
             document.querySelectorAll('.bookable-restaurant-card').forEach(card => {
                 card.classList.remove('selected-for-booking');
             });
             console.log("Booking form fields cleared and highlight removed."); // Debug log
         }


        // --- Initial Load ---
        // Wait for the DOM to be fully loaded before accessing elements
        document.addEventListener('DOMContentLoaded', () => {
             // Check if user data exists on load. If so, show main content, otherwise show auth screen.
             if (userData) {
                 showMainAppContent();
                 loadPendingBookings(); // Load pending bookings on app load
             } else {
                 showAuthScreen();
             }

            // Get references to filtering and search elements AFTER DOM is loaded
            const categoryFilterButtons = document.querySelectorAll('.category-chip'); // Changed selector to .category-chip
            const searchInput = document.getElementById('restaurantSearchInput');
            const searchButton = document.getElementById('searchButton');

            // Add event listeners to category filter buttons to update filter and re-render
            categoryFilterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remove 'active' class from all buttons and add to the clicked one
                    categoryFilterButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    // Update the current category and trigger filtering and rendering
                    currentCategory = button.dataset.category;
                    filterAndRenderBags();
                });
            });

            // Add event listeners for the search button and input field
            searchButton.addEventListener('click', () => {
                currentSearchTerm = searchInput.value;
                filterAndRenderBags();
            });
            searchInput.addEventListener('keyup', (event) => {
                // Trigger search on Enter key press
                if (event.key === 'Enter') {
                    currentSearchTerm = searchInput.value;
                    filterAndRenderBags();
                }
            });

             // Add event listeners to the delivery option radio buttons (moved inside DOMContentLoaded)
             deliveryOptionRadios.forEach(radio => {
                 radio.addEventListener('change', () => {
                     updateDeliveryAddressFieldsVisibility();
                     updateDeliveryPriorityVisibility();
                     populateTimeOptions(); // Repopulate time options based on selection
                 });
             });

              // Add event listeners to the payment method radio buttons (moved inside DOMContentLoaded)
              paymentMethodRadios.forEach(radio => {
                  radio.addEventListener('change', updateDummyPaymentFieldsVisibility);
              });

             // Add event listeners for the show/hide auth view buttons using their IDs
             if (showSignupBtn) { // Check if the element exists
                 showSignupBtn.addEventListener('click', showSignupView);
             }
             if (showLoginBtn) { // Check if the element exists
                 showLoginBtn.addEventListener('click', showLoginView);
             }


             // Add event listener for the "Book a Table" header to show the booking page
             const bookTableHeader = document.querySelector('.book-table-header');
             if (bookTableHeader) {
                 bookTableHeader.addEventListener('click', showBookingPageSection);
                 console.log("Event listener added to .book-table-header"); // Debug log
             } else {
                 console.error("Could not find .book-table-header element."); // Debug log
             }

             // The toggleBookingFormButton is removed as the header handles navigation now.
             // If you want a button *on the booking page* to toggle the form visibility
             // independently of card selection, you would add an event listener here.

             // Add event listener for the "Confirm Booking" button
             confirmBookingButton.addEventListener('click', handleConfirmBooking);

        });


        // Removed the service worker registration code as it's not needed for this single HTML file simulation


    </script>
</body>
</html>
